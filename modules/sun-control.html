<style>
    /* å®¹å™¨æ ·å¼ */
    #sun-interaction-container {
        position: relative;
        width: 100%;
        height: 600px;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    #three-canvas { width: 100%; height: 100%; display: block; }
    
    /* UI æ ·å¼ */
    .ui-overlay {
        position: absolute; top: 20px; left: 20px; z-index: 10;
        color: white; font-family: 'Segoe UI', sans-serif;
        text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        pointer-events: none;
    }
    .status-badge {
        display: inline-block; padding: 6px 12px;
        background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3);
        border-radius: 20px; backdrop-filter: blur(4px);
        font-size: 14px; margin-bottom: 10px;
        color: #ffd700; transition: all 0.3s;
    }
    
    .cam-preview {
        position: absolute; bottom: 20px; right: 20px;
        width: 120px; height: 90px; border-radius: 8px; overflow: hidden;
        border: 2px solid rgba(255,255,255,0.5); z-index: 10; background: #000;
    }
    #input-video { position: absolute; opacity: 0; pointer-events: none; }
    #output-canvas { width: 100%; height: 100%; transform: scaleX(-1); }
</style>

<div id="sun-interaction-container">
    <div class="ui-overlay">
        <div id="status-text" class="status-badge">æ­£åœ¨åˆå§‹åŒ–æœ¬åœ°å¼•æ“...</div>
        <div style="font-size:12px; opacity:0.9">âœ‹ å¼ å¼€ï¼šæ—¥å‡º (æµ·é¢æ³¢å…‰) | âœŠ æ¡æ‹³ï¼šæ—¥è½ (æ™šéœ)</div>
    </div>

    <div class="cam-preview"><canvas id="output-canvas"></canvas></div>
    <video id="input-video" playsinline></video>
    <div id="three-canvas"></div>
</div>

<script src="js/three.min.js"></script>
<script src="js/camera_utils.js"></script>
<script src="js/control_utils.js"></script>
<script src="js/drawing_utils.js"></script>
<script src="js/hands.js"></script>

<script src="js/Water.js"></script>
<script src="js/Sky.js"></script>

<script>
    const statusText = document.getElementById('status-text');

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šç”¨ Canvas ä»£ç åŠ¨æ€ç”Ÿæˆæµ·é¢æ³¢çº¹å›¾ â˜…â˜…â˜…
    // è¿™æ ·å°±ä¸éœ€è¦å»åŠ è½½é‚£ä¸ªè¢«å¢™çš„ waternormals.jpg äº†
    function createWaterNormalTexture() {
        const size = 512;
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // å¡«å……è“è‰²åº•
        ctx.fillStyle = '#8080ff'; 
        ctx.fillRect(0, 0, size, size);

        // ç”»ä¸€äº›éšæœºå™ªç‚¹æ¨¡æ‹Ÿæ³¢æµªæ³•çº¿
        for (let i = 0; i < 20000; i++) {
            const x = Math.random() * size;
            const y = Math.random() * size;
            const r = Math.random() * 2 + 1;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            // æ¨¡æ‹Ÿæ³•çº¿è´´å›¾çš„é¢œè‰²æ‰°åŠ¨
            ctx.fillStyle = `rgba(${128 + Math.random()*127}, ${128 + Math.random()*127}, 255, 0.5)`;
            ctx.fill();
        }
        
        const texture = new THREE.CanvasTexture(canvas);
        texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
        return texture;
    }

    // ================= 1. 3D åœºæ™¯åˆå§‹åŒ– =================
    try {
        // æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½æˆåŠŸ
        if (typeof THREE.Water === 'undefined' || typeof THREE.Sky === 'undefined') {
            throw new Error("æ‰¾ä¸åˆ° Water.js æˆ– Sky.jsï¼Œè¯·æ£€æŸ¥ js æ–‡ä»¶å¤¹");
        }

        const container = document.getElementById('three-canvas');
        const width = container.clientWidth;
        const height = container.clientHeight;

        const scene = new THREE.Scene();

        const camera = new THREE.PerspectiveCamera(55, width / height, 1, 20000);
        camera.position.set(30, 30, 100);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        container.appendChild(renderer.domElement);

        const sun = new THREE.Vector3();

        // --- åˆ›å»ºæµ·æ´‹ (ä½¿ç”¨ä»£ç ç”Ÿæˆçš„çº¹ç†) ---
        const waterGeometry = new THREE.PlaneGeometry(10000, 10000);

        const water = new THREE.Water(
            waterGeometry,
            {
                textureWidth: 512,
                textureHeight: 512,
                waterNormals: createWaterNormalTexture(), // â˜… è°ƒç”¨ç”Ÿæˆå‡½æ•°
                sunDirection: new THREE.Vector3(),
                sunColor: 0xffffff,
                waterColor: 0x001e0f,
                distortionScale: 3.7,
                fog: scene.fog !== undefined
            }
        );
        water.rotation.x = - Math.PI / 2;
        scene.add(water);

        // --- åˆ›å»ºå¤©ç©º ---
        const sky = new THREE.Sky();
        sky.scale.setScalar(10000);
        scene.add(sky);

        const skyUniforms = sky.material.uniforms;
        skyUniforms['turbidity'].value = 10;
        skyUniforms['rayleigh'].value = 2;
        skyUniforms['mieCoefficient'].value = 0.005; 
        skyUniforms['mieDirectionalG'].value = 0.8;

        // --- å¯è§†åŒ–å¤ªé˜³ ---
        const sunSphere = new THREE.Mesh(
            new THREE.SphereGeometry(200, 32, 32),
            new THREE.MeshBasicMaterial({ color: 0xffffaa })
        );
        scene.add(sunSphere);

        // ================= 2. é€»è¾‘æ§åˆ¶ =================

        let elevation = 0; 
        let moveState = 0; 
        const SPEED = 0.003; 

        function updateSunPosition() {
            if (moveState !== 0) {
                elevation += moveState * SPEED;
                if (elevation > 0.4) elevation = 0.4; 
                if (elevation < -0.05) elevation = -0.05; 
            }

            const phi = THREE.MathUtils.degToRad(90 - (elevation * 180)); 
            const theta = THREE.MathUtils.degToRad(180); 

            sun.setFromSphericalCoords(1, phi, theta);

            sky.material.uniforms['sunPosition'].value.copy(sun);
            water.material.uniforms['sunDirection'].value.copy(sun).normalize();
            sunSphere.position.copy(sun).multiplyScalar(4000); 
            
            const sunColor = new THREE.Color(0xff0000).lerp(new THREE.Color(0xffffeb), (elevation + 0.05) * 2.5);
            sunSphere.material.color.copy(sunColor);
        }

        function animate() {
            requestAnimationFrame(animate);
            water.material.uniforms[ 'time' ].value += 1.0 / 60.0;
            updateSunPosition();
            renderer.render(scene, camera);
        }
        animate();

        // ================= 3. AI æ‰‹åŠ¿è¯†åˆ« =================
        
        const videoElement = document.getElementById('input-video');
        const canvasElement = document.getElementById('output-canvas');
        const canvasCtx = canvasElement.getContext('2d');

        function onResults(results) {
            statusText.innerText = "ç³»ç»Ÿè¿è¡Œä¸­ï¼Œè¯·å±•ç¤ºæ‰‹åŠ¿";
            statusText.style.color = "yellow";
            
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

                const wrist = landmarks[0];
                const middleTip = landmarks[12];
                const dist = Math.sqrt(Math.pow(middleTip.x - wrist.x, 2) + Math.pow(middleTip.y - wrist.y, 2));

                if (dist > 0.32) {
                    moveState = 1; 
                    statusText.innerText = "çŠ¶æ€ï¼šğŸ–ï¸ æ—¥å‡º (æµ·é¢æ³¢å…‰æµ®ç°)";
                    statusText.style.color = "#00ff00";
                } else if (dist < 0.22) {
                    moveState = -1; 
                    statusText.innerText = "çŠ¶æ€ï¼šâœŠ æ—¥è½ (æ­£åœ¨è¿›å…¥é»„æ˜)";
                    statusText.style.color = "#ff4400";
                } else {
                    moveState = 0; 
                    statusText.innerText = "çŠ¶æ€ï¼šâœ‹ æ‚¬åœ (æ¬£èµå½“å‰ç¾æ™¯)";
                    statusText.style.color = "white";
                }
            } else {
                moveState = 0;
            }
            canvasCtx.restore();
        }

        const hands = new Hands({locateFile: (file) => {
            // MediaPipe çš„æ ¸å¿ƒæ¨¡å‹ä¾ç„¶å»ºè®®èµ° CDNï¼Œå¦‚æœä½ ä¹Ÿä¸‹è½½äº† binaryï¼Œè¿™é‡Œå¯ä»¥æ”¹æˆæœ¬åœ°
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        statusText.innerText = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 320,
            height: 240
        });
        
        cameraUtils.start();

        // çª—å£å¤§å°æ”¹å˜æ—¶è‡ªé€‚åº”
        window.addEventListener('resize', onWindowResize, false);
        function onWindowResize() {
            if(!container) return;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( container.clientWidth, container.clientHeight );
        }

    } catch (e) {
        statusText.innerText = "âŒ åˆå§‹åŒ–é”™è¯¯: " + e.message;
        statusText.style.color = "red";
        console.error(e);
    }

</script>