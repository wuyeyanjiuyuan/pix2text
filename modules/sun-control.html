<style>
    /* å®¹å™¨æ ·å¼ */
    #sun-interaction-container {
        position: relative;
        width: 100%;
        height: 600px; /* é«˜åº¦å›ºå®šï¼Œä¿è¯è§†é‡ */
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    /* 3D ç”»å¸ƒ */
    #three-canvas {
        width: 100%;
        height: 100%;
        display: block;
    }

    /* éšè—çš„æ‘„åƒå¤´è§†é¢‘å…ƒç´ ï¼ˆç”¨äºAIè¯†åˆ«ï¼‰ */
    #input-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 1px; 
        height: 1px;
        opacity: 0;
        pointer-events: none;
    }

    /* UI å±‚ï¼šçŠ¶æ€ä¸æ§åˆ¶ */
    .ui-overlay {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        color: white;
        font-family: 'Segoe UI', sans-serif;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        pointer-events: none; /* è®©é¼ æ ‡èƒ½ç©¿é€å»ç‚¹å‡»èƒŒæ™¯æŒ‰é’® */
    }

    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        background: rgba(0,0,0,0.6);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 20px;
        backdrop-filter: blur(4px);
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .status-badge.loading { color: #ffd700; }
    .status-badge.active { color: #00ff00; border-color: #00ff00; }

    /* èƒŒæ™¯åˆ‡æ¢æŒ‰é’®ç»„ */
    .bg-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 20;
    }

    .bg-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.4);
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        backdrop-filter: blur(4px);
        font-size: 14px;
    }
    .bg-btn:hover, .bg-btn.active {
        background: white;
        color: #333;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(255,255,255,0.3);
    }
    
    /* æ‘„åƒå¤´é¢„è§ˆçª—ï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿ç”¨æˆ·çœ‹æ‰‹åŠ¿ï¼‰ */
    .cam-preview {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 120px;
        height: 90px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.5);
        z-index: 10;
        background: #000;
    }
    /* è¿™é‡Œçš„ canvas æ˜¯ MediaPipe ç”»å‡ºæ¥çš„éª¨æ¶å›¾ */
    #output-canvas {
        width: 100%;
        height: 100%;
        transform: scaleX(-1); /* é•œåƒç¿»è½¬ï¼Œç¬¦åˆç›´è§‰ */
    }
</style>

<div id="sun-interaction-container">
    <div class="ui-overlay">
        <div id="status-text" class="status-badge loading">æ­£åœ¨å¯åŠ¨ AI è§†è§‰å¼•æ“...</div>
        <div>âœ‹ å¼ å¼€æ‰‹æŒï¼šå‡èµ·å¤ªé˜³ | âœŠ æ¡ç´§æ‹³å¤´ï¼šè½ä¸‹å¤ªé˜³</div>
    </div>

    <div class="bg-controls">
        <button class="bg-btn active" onclick="changeScene('ocean')">ğŸŒŠ å¤§æµ·</button>
        <button class="bg-btn" onclick="changeScene('city')">ğŸ™ï¸ é«˜æ¥¼</button>
        <button class="bg-btn" onclick="changeScene('forest')">ğŸŒ² æ£®æ—</button>
        <button class="bg-btn" onclick="changeScene('roof')">ğŸ  å±‹é¡¶</button>
    </div>

    <div class="cam-preview">
        <canvas id="output-canvas"></canvas>
    </div>

    <video id="input-video" playsinline></video>
    <div id="three-canvas"></div>
</div>

<script src="js/three.min.js"></script>
<script src="js/camera_utils.js"></script>
<script src="js/control_utils.js"></script>
<script src="js/drawing_utils.js"></script>
<script src="js/hands.js"></script>

<script>
    // ================= 1. Three.js åœºæ™¯åˆå§‹åŒ– (è§†è§‰éƒ¨åˆ†) =================
    const container = document.getElementById('three-canvas');
    const width = container.clientWidth;
    const height = container.clientHeight;

    const scene = new THREE.Scene();
    // å¢åŠ ä¸€ç‚¹é›¾æ°”ï¼Œè®©è¿œå¤„æœ‰æœ¦èƒ§æ„Ÿ
    scene.fog = new THREE.FogExp2(0x11111f, 0.002);

    const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
    camera.position.set(0, 5, 20); // ç›¸æœºä½ç½®

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    // --- å¤ªé˜³å¯¹è±¡ ---
    const sunGeometry = new THREE.SphereGeometry(4, 32, 32);
    const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffaa00 });
    const sunMesh = new THREE.Mesh(sunGeometry, sunMaterial);
    scene.add(sunMesh);

    // å¤ªé˜³å…‰æ™• (Sprite)
    const textureLoader = new THREE.TextureLoader();
    // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å…‰æ™•è´´å›¾ç”Ÿæˆé€»è¾‘ï¼Œä¸ºäº†ä¸ä¾èµ–å¤–éƒ¨å›¾ç‰‡ï¼Œæˆ‘ä»¬ç”¨ Canvas ç”Ÿæˆä¸€ä¸ª
    function createGlowTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 128; canvas.height = 128;
        const ctx = canvas.getContext('2d');
        const gradient = ctx.createRadialGradient(64,64,0, 64,64,64);
        gradient.addColorStop(0, 'rgba(255, 200, 100, 1)');
        gradient.addColorStop(0.4, 'rgba(255, 100, 0, 0.5)');
        gradient.addColorStop(1, 'rgba(255, 100, 0, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0,0,128,128);
        return new THREE.CanvasTexture(canvas);
    }
    const glowMaterial = new THREE.SpriteMaterial({ 
        map: createGlowTexture(), 
        color: 0xffaa00, 
        transparent: true, 
        opacity: 0.8,
        blending: THREE.AdditiveBlending
    });
    const sunGlow = new THREE.Sprite(glowMaterial);
    sunGlow.scale.set(15, 15, 1);
    sunMesh.add(sunGlow); // å…‰æ™•è·Ÿéšå¤ªé˜³

    // --- å…‰ç…§ç³»ç»Ÿ ---
    const ambientLight = new THREE.AmbientLight(0x404040, 0.5); // ç¯å¢ƒå…‰
    scene.add(ambientLight);

    const sunLight = new THREE.DirectionalLight(0xffaa33, 1);
    sunLight.castShadow = true;
    scene.add(sunLight);

    // --- ç²’å­ç³»ç»Ÿ (å…‰å½±å°˜åŸƒ) ---
    const particleCount = 1000;
    const particlesGeom = new THREE.BufferGeometry();
    const particlePositions = [];
    for(let i=0; i<particleCount; i++) {
        particlePositions.push((Math.random() - 0.5) * 50); // x
        particlePositions.push((Math.random() - 0.5) * 30); // y
        particlePositions.push((Math.random() - 0.5) * 50); // z
    }
    particlesGeom.setAttribute('position', new THREE.Float32BufferAttribute(particlePositions, 3));
    const particleMat = new THREE.PointsMaterial({
        color: 0xffffff,
        size: 0.2,
        transparent: true,
        opacity: 0.6
    });
    const particleSystem = new THREE.Points(particlesGeom, particleMat);
    scene.add(particleSystem);

    // --- åœ°é¢/èƒŒæ™¯ (å ä½ï¼Œå¯æ›¿æ¢ä¸ºæ¨¡å‹) ---
    const groundGeo = new THREE.PlaneGeometry(200, 200);
    const groundMat = new THREE.MeshStandardMaterial({ 
        color: 0x222222, 
        roughness: 0.8,
        metalness: 0.2 
    });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -5;
    scene.add(ground);

    // ================= 2. é€»è¾‘æ§åˆ¶ (åŠ¨ç”»ä¸äº¤äº’) =================

    let targetSunY = -10; // ç›®æ ‡é«˜åº¦ (-10 æ˜¯è½ä¸‹, 10 æ˜¯æ­£åˆ)
    let currentSunY = -10;
    
    // èƒŒæ™¯é…ç½®é¢œè‰² (æ¨¡æ‹Ÿä¸åŒåœºæ™¯çš„è‰²è°ƒ)
    const scenes = {
        ocean:  { skyTop: 0x0077ff, skyBot: 0x001133, ground: 0x004488 },
        city:   { skyTop: 0x555577, skyBot: 0x111122, ground: 0x111111 },
        forest: { skyTop: 0x88ccff, skyBot: 0x004400, ground: 0x003300 },
        roof:   { skyTop: 0xffaa88, skyBot: 0x442244, ground: 0x332222 }
    };
    let currentScene = 'ocean';

    // åˆ‡æ¢åœºæ™¯å‡½æ•°
    window.changeScene = function(name) {
        currentScene = name;
        // æ›´æ–°æŒ‰é’®æ ·å¼
        document.querySelectorAll('.bg-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        // å®é™…å¦‚æœè¦æ¢èƒŒæ™¯å›¾ï¼Œåœ¨è¿™é‡Œ textureLoader.load('images/xxx.jpg')
    }

    function updateEnvironment() {
        // 1. å¤ªé˜³å¹³æ»‘ç§»åŠ¨
        currentSunY += (targetSunY - currentSunY) * 0.05;
        sunMesh.position.set(0, currentSunY, -20);
        sunLight.position.set(0, currentSunY, -20);

        // 2. æ ¹æ®å¤ªé˜³é«˜åº¦è®¡ç®— "ç™½å¤©ç¨‹åº¦" (0 = é»‘å¤œ, 1 = ç™½å¤©)
        const dayProgress = Math.min(Math.max((currentSunY + 5) / 15, 0), 1);

        // 3. åŠ¨æ€æ”¹å˜å¤©ç©ºé¢œè‰² (ç®€å•çš„é›¾é¢œè‰²å˜åŒ–)
        const sceneConfig = scenes[currentScene];
        const skyColor = new THREE.Color(sceneConfig.skyBot).lerp(new THREE.Color(sceneConfig.skyTop), dayProgress);
        scene.fog.color.copy(skyColor);
        renderer.setClearColor(skyColor);

        // 4. å¤ªé˜³é¢œè‰²å˜åŒ– (ä½å¤„çº¢ï¼Œé«˜å¤„é»„)
        const sunColor = new THREE.Color(0xff0000).lerp(new THREE.Color(0xffffaa), dayProgress);
        sunMaterial.color.copy(sunColor);
        sunGlow.material.color.copy(sunColor);

        // 5. å…‰ç…§å¼ºåº¦å˜åŒ–
        sunLight.intensity = dayProgress * 1.5;
        ambientLight.intensity = 0.2 + (dayProgress * 0.5);

        // 6. ç²’å­åŠ¨ç”» (ç¨å¾®æ¼‚æµ®)
        particleSystem.rotation.y += 0.001;
    }

    function animate() {
        requestAnimationFrame(animate);
        updateEnvironment();
        renderer.render(scene, camera);
    }
    animate();

    // ================= 3. MediaPipe Hands (AI æ‰‹åŠ¿è¯†åˆ«) =================
    
    const videoElement = document.getElementById('input-video');
    const canvasElement = document.getElementById('output-canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusText = document.getElementById('status-text');

    function onResults(results) {
        statusText.classList.remove('loading');
        statusText.classList.add('active');
        statusText.innerText = "AI è§†è§‰å¼•æ“å·²è¿æ¥";

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // ç”»éª¨æ¶
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

            // --- æ ¸å¿ƒç®—æ³•ï¼šè®¡ç®—æ‰‹æŒå¼ å¼€ç¨‹åº¦ ---
            // æˆ‘ä»¬è®¡ç®—æŒ‡å°– (Tip) åˆ° æ‰‹æŒæ ¹éƒ¨ (Wrist, index 0) çš„è·ç¦»
            // index 4=æ‹‡æŒ‡å°–, 8=é£ŸæŒ‡å°–, 12=ä¸­æŒ‡å°–, 16=æ— åæŒ‡å°–, 20=å°æŒ‡å°–
            // ç®€å•ç®—æ³•ï¼šè®¡ç®—ä¸­æŒ‡æŒ‡å°–(12)åˆ°æ‰‹è…•(0)çš„è·ç¦»
            
            const wrist = landmarks[0];
            const middleTip = landmarks[12];
            const thumbTip = landmarks[4];
            const pinkyTip = landmarks[20];

            // è·ç¦»å…¬å¼
            const dist = Math.sqrt(
                Math.pow(middleTip.x - wrist.x, 2) + 
                Math.pow(middleTip.y - wrist.y, 2)
            );

            // é˜ˆå€¼åˆ¤æ–­ (ç”±äºæ˜¯å½’ä¸€åŒ–åæ ‡ï¼Œ0.4 å·¦å³é€šå¸¸æ˜¯å¼ å¼€ï¼Œ0.2 å·¦å³æ˜¯æ¡æ‹³)
            // æˆ‘ä»¬å¯ä»¥ç”¨æ›´é²æ£’çš„æ–¹æ³•ï¼šåˆ¤æ–­æ‰€æœ‰æ‰‹æŒ‡æŒ‡å°–æ˜¯å¦è¿œç¦»æŒå¿ƒ
            
            // ç®€å•ç‰ˆï¼šå¦‚æœä¸­æŒ‡è·ç¦»æ‰‹è…•å¤Ÿè¿œï¼Œä¸”æ‹‡æŒ‡å’Œå°æŒ‡åˆ†å¼€ -> å¼ å¼€
            const handOpenness = dist; 

            if (handOpenness > 0.35) {
                // æ‰‹å¼ å¼€äº† -> å¤ªé˜³ä¸Šå‡
                statusText.innerText = "çŠ¶æ€ï¼šğŸ–ï¸ å¼ å¼€ (å¤ªé˜³å‡èµ·)";
                targetSunY = 10; // å‡åˆ°é«˜ç©º
            } else {
                // æ‰‹é—­åˆäº† -> å¤ªé˜³è½ä¸‹
                statusText.innerText = "çŠ¶æ€ï¼šâœŠ é—­åˆ (å¤ªé˜³è½ä¸‹)";
                targetSunY = -8; // è½åˆ°åœ°å¹³çº¿ä»¥ä¸‹
            }

        } else {
            statusText.innerText = "æœªæ£€æµ‹åˆ°æ‰‹åŠ¿ï¼Œè¯·åœ¨æ‘„åƒå¤´å‰æ™ƒåŠ¨æ‰‹";
        }
        canvasCtx.restore();
    }

    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1, // 0æœ€å¿«, 1æ™®é€š, 2æœ€å‡†. 1å¯¹æ˜¾å¡å‹åŠ›å¾ˆå°
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(onResults);

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 320, // é™ä½å¤„ç†åˆ†è¾¨ç‡ä»¥æé«˜æ€§èƒ½
        height: 240
    });
    
    // å¯åŠ¨æ‘„åƒå¤´
    cameraUtils.start();

</script>