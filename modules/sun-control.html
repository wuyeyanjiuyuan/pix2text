<style>
    #sun-interaction-container {
        position: relative;
        width: 100%;
        height: 600px;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    #three-canvas { width: 100%; height: 100%; display: block; }
    #input-video { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    
    /* UI æ ·å¼ä¼˜åŒ– */
    .ui-overlay {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        color: white;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        pointer-events: none;
    }
    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        background: rgba(0,0,0,0.6);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 20px;
        backdrop-filter: blur(4px);
        font-size: 14px;
        margin-bottom: 10px;
        transition: color 0.3s;
    }

    /* åœºæ™¯åˆ‡æ¢æŒ‰é’® */
    .bg-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 20;
    }
    .bg-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.4);
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        backdrop-filter: blur(4px);
        font-size: 14px;
    }
    .bg-btn:hover, .bg-btn.active {
        background: white;
        color: #333;
        transform: translateY(-2px);
    }

    .cam-preview {
        position: absolute;
        bottom: 20px; right: 20px;
        width: 120px; height: 90px;
        border-radius: 8px; overflow: hidden;
        border: 2px solid rgba(255,255,255,0.5);
        z-index: 10; background: #000;
    }
    #output-canvas { width: 100%; height: 100%; transform: scaleX(-1); }
</style>

<div id="sun-interaction-container">
    <div class="ui-overlay">
        <div id="status-text" class="status-badge" style="color:yellow;">æ­£åœ¨è¿æ¥æ‘„åƒå¤´...</div>
        <div style="font-size: 12px; opacity: 0.8;">
            ğŸ–ï¸ å¼ å¼€ï¼šæŒç»­ä¸Šå‡ | âœŠ æ¡æ‹³ï¼šæŒç»­ä¸‹é™ | âœ‹ ç§»å¼€ï¼šæ‚¬åœ
        </div>
    </div>

    <div class="bg-controls">
        <button class="bg-btn active" onclick="changeScene('ocean')">ğŸŒŠ å¤§æµ·</button>
        <button class="bg-btn" onclick="changeScene('city')">ğŸ™ï¸ é«˜æ¥¼</button>
        <button class="bg-btn" onclick="changeScene('forest')">ğŸŒ² æ£®æ—</button>
    </div>

    <div class="cam-preview"><canvas id="output-canvas"></canvas></div>
    <video id="input-video" playsinline></video>
    <div id="three-canvas"></div>
</div>

<script src="js/three.min.js"></script>
<script src="js/camera_utils.js"></script>
<script src="js/control_utils.js"></script>
<script src="js/drawing_utils.js"></script>
<script src="js/hands.js"></script>

<script>
    // è·å–çŠ¶æ€æ ï¼Œç”¨äºæ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
    const statusText = document.getElementById('status-text');
    
    // --- 0. è‡ªæˆ‘è¯Šæ–­ï¼šæ£€æŸ¥ JS æ˜¯å¦åŠ è½½æˆåŠŸ ---
    function checkDependencies() {
        let missing = [];
        if (typeof THREE === 'undefined') missing.push('Three.js');
        if (typeof Hands === 'undefined') missing.push('Hands.js');
        if (typeof Camera === 'undefined') missing.push('CameraUtils.js');
        
        if (missing.length > 0) {
            statusText.innerText = "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ " + missing.join(', ');
            statusText.style.color = "red";
            throw new Error("ä¾èµ–ä¸¢å¤±");
        }
    }

    try {
        checkDependencies();
    } catch (e) {
        console.error(e);
        // å¦‚æœè¿™é‡ŒæŠ¥é”™ï¼Œè¯´æ˜ä½ çš„ js æ–‡ä»¶å¤¹ä½ç½®ä¸å¯¹ï¼Œæˆ–è€…æ–‡ä»¶åä¸å¯¹
    }

    // ================= 1. 3D åœºæ™¯åˆå§‹åŒ– (ä¿æŒä¸å˜) =================
    const container = document.getElementById('three-canvas');
    const width = container.clientWidth;
    const height = container.clientHeight;

    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.02); 

    const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
    camera.position.set(0, 0, 20);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    // --- åŠ¨æ€èƒŒæ™¯å¢™ ---
    const bgGeometry = new THREE.PlaneGeometry(200, 120); 
    const bgMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 });
    const bgMesh = new THREE.Mesh(bgGeometry, bgMaterial);
    bgMesh.position.z = -50;
    scene.add(bgMesh);

    // --- å¤ªé˜³ä¸»ä½“ ---
    const sunGeometry = new THREE.SphereGeometry(3, 64, 64);
    const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffaa00 });
    const sunMesh = new THREE.Mesh(sunGeometry, sunMaterial);
    scene.add(sunMesh);

    // --- å¤ªé˜³å…‰æ™• ---
    function createGlowTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 128; canvas.height = 128;
        const ctx = canvas.getContext('2d');
        const gradient = ctx.createRadialGradient(64,64,0, 64,64,64);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
        gradient.addColorStop(0.2, 'rgba(255, 200, 100, 0.6)');
        gradient.addColorStop(0.5, 'rgba(255, 100, 50, 0.2)');
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0,0,128,128);
        return new THREE.CanvasTexture(canvas);
    }
    const sunGlow = new THREE.Sprite(new THREE.SpriteMaterial({ map: createGlowTexture(), color: 0xffaa00, transparent: true, blending: THREE.AdditiveBlending }));
    sunGlow.scale.set(25, 25, 1);
    sunMesh.add(sunGlow);

    // --- èµ„æºåŠ è½½ ---
    const textureLoader = new THREE.TextureLoader();
    const bgImages = {
        'ocean': 'https://images.unsplash.com/photo-1518837695005-2083093ee35b?q=80&w=1000&auto=format&fit=crop',
        'city':  'https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?q=80&w=1000&auto=format&fit=crop',
        'forest': 'https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=1000&auto=format&fit=crop'
    };

    window.changeScene = function(key) {
        document.querySelectorAll('.bg-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        textureLoader.load(bgImages[key], function(texture) {
            bgMesh.material.map = texture;
            bgMesh.material.needsUpdate = true;
        });
    }
    changeScene('ocean'); 

    // --- åŠ¨ç”»é€»è¾‘ ---
    let currentHeight = -8; 
    let moveState = 0;      
    const SPEED = 0.08;     
    const MAX_H = 8;        
    const MIN_H = -8;       

    function animate() {
        requestAnimationFrame(animate);
        if (moveState !== 0) {
            currentHeight += moveState * SPEED;
            if (currentHeight > MAX_H) currentHeight = MAX_H;
            if (currentHeight < MIN_H) currentHeight = MIN_H;
        }
        sunMesh.position.y = currentHeight;

        const progress = (currentHeight - MIN_H) / (MAX_H - MIN_H);
        const sunColor = new THREE.Color(0xff3300).lerp(new THREE.Color(0xffffcc), progress);
        sunMaterial.color.copy(sunColor);
        sunGlow.material.color.copy(sunColor);

        const bgTint = new THREE.Color(0x222244).lerp(new THREE.Color(0xffffff), progress);
        bgMesh.material.color.copy(bgTint);

        const fogColor = new THREE.Color(0x000000).lerp(new THREE.Color(0x224488), progress);
        scene.fog.color.copy(fogColor);
        scene.fog.density = 0.02 - (progress * 0.015);
        renderer.render(scene, camera);
    }
    animate();

    // ================= 4. AI æ‰‹åŠ¿è¯†åˆ« (å¸¦é”™è¯¯è¯Šæ–­) =================
    
    const videoElement = document.getElementById('input-video');
    const canvasElement = document.getElementById('output-canvas');
    const canvasCtx = canvasElement.getContext('2d');

    function onResults(results) {
        // ä¸€æ—¦æˆåŠŸè¯†åˆ«åˆ°ä¸€æ¬¡ï¼Œå°±è¯´æ˜æ¨¡å‹åŠ è½½å®Œæ¯•äº†
        if(statusText.innerText.includes("åŠ è½½æ¨¡å‹")) {
            statusText.innerText = "çŠ¶æ€ï¼šç³»ç»Ÿå°±ç»ªï¼Œè¯·ä¼¸æ‰‹";
            statusText.style.color = "yellow";
        }

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

            const wrist = landmarks[0];
            const tips = [8, 12, 16, 20];
            let avgDist = 0;
            tips.forEach(idx => {
                const dx = landmarks[idx].x - wrist.x;
                const dy = landmarks[idx].y - wrist.y;
                avgDist += Math.sqrt(dx*dx + dy*dy);
            });
            avgDist /= 4; 

            if (avgDist > 0.3) {
                moveState = 1; statusText.innerText = "çŠ¶æ€ï¼šğŸ–ï¸ å¼ å¼€ (æ­£åœ¨ä¸Šå‡)"; statusText.style.color = "#00ff00";
            } else if (avgDist < 0.2) {
                moveState = -1; statusText.innerText = "çŠ¶æ€ï¼šâœŠ æ¡æ‹³ (æ­£åœ¨ä¸‹é™)"; statusText.style.color = "#ff4400";
            } else {
                moveState = 0; statusText.innerText = "çŠ¶æ€ï¼šâœ‹ ä¿æŒ";
            }
        } else {
            // æ²¡æ£€æµ‹åˆ°æ‰‹çš„æ—¶å€™ï¼Œä¸éœ€è¦ç–¯ç‹‚åˆ·æ–°æ–‡å­—ï¼Œæå‡æ€§èƒ½
            if(moveState !== 0) {
                moveState = 0; statusText.innerText = "çŠ¶æ€ï¼šâœ‹ ç­‰å¾…æ‰‹åŠ¿..."; statusText.style.color = "yellow";
            }
        }
        canvasCtx.restore();
    }

    // â˜…â˜…â˜… é‡ç‚¹ï¼šæ¨¡å‹åŠ è½½é…ç½® â˜…â˜…â˜…
    statusText.innerText = "æ­£åœ¨ä¸‹è½½ AI æ¨¡å‹ (çº¦ 10MB)...";
    
    const hands = new Hands({locateFile: (file) => {
        // ä½¿ç”¨ jsdelivrï¼Œè¿™åœ¨å›½å†…æ¯” unpkg ç¨å¾®ç¨³å®šä¸€ç‚¹ç‚¹
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    // â˜…â˜…â˜… å¯åŠ¨æ‘„åƒå¤´å¹¶æ•è·é”™è¯¯ â˜…â˜…â˜…
    try {
        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 320,
            height: 240
        });
        
        cameraUtils.start()
            .then(() => {
                console.log("æ‘„åƒå¤´å·²å¯åŠ¨");
                // åªæœ‰å½“æ‘„åƒå¤´çœŸæ­£å¯åŠ¨åï¼Œæ‰æ˜¾ç¤ºæ¨¡å‹åŠ è½½ä¸­
                if(!statusText.innerText.includes("é”™è¯¯")) {
                    statusText.innerText = "æ‘„åƒå¤´å·²å¼€ï¼Œæ­£åœ¨åŠ è½½ AI æ¨¡å‹...";
                }
            })
            .catch(err => {
                statusText.innerText = "âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼è¯·å…è®¸æƒé™";
                statusText.style.color = "red";
                console.error(err);
            });
            
    } catch(err) {
        statusText.innerText = "âŒ åˆå§‹åŒ–å¤±è´¥: " + err.message;
        statusText.style.color = "red";
    }
</script>