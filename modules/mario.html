<style>
    /* === å®¹å™¨å¸ƒå±€ === */
    #mario-wrapper {
        position: relative;
        width: 100%;
        height: 600px;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* === åµŒå…¥çš„æ¸¸æˆ iframe === */
    #game-iframe {
        width: 100%;
        height: 100%;
        border: none;
        outline: none;
        display: block;
    }

    /* === UI è¦†ç›–å±‚ === */
    .overlay-ui {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€åˆ° iframe */
        z-index: 10;
    }

    /* æ‘„åƒå¤´ç”»ä¸­ç”» */
    .cam-box {
        position: absolute; bottom: 20px; right: 20px;
        width: 160px; height: 120px;
        border: 3px solid rgba(255,255,255,0.5);
        border-radius: 8px; background: #000;
        overflow: hidden;
        transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
        z-index: 20;
    }
    #input-video { display: none; }
    #debug-canvas { width: 100%; height: 100%; }

    /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .status-panel {
        position: absolute; top: 20px; left: 20px;
        background: rgba(0,0,0,0.7);
        padding: 10px; border-radius: 8px;
        color: white; font-family: 'Segoe UI', sans-serif; font-size: 14px;
        border-left: 4px solid #e52521;
        pointer-events: none;
    }
    .status-item { margin-bottom: 4px; opacity: 0.5; transition: 0.1s; }
    .status-item.active { opacity: 1; color: #ffce00; font-weight: bold; text-shadow: 0 0 5px orange; }
    
    .key-badge {
        display: inline-block; width: 20px; height: 20px; 
        background: #333; text-align: center; line-height: 20px; 
        border-radius: 4px; font-size: 12px; margin-right: 5px;
    }

    /* é®ç½©æç¤º */
    #loading-mask {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); color: #fff; z-index: 50;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        text-align: center;
        backdrop-filter: blur(5px);
    }
    .btn-load {
        margin-top: 20px; padding: 12px 30px;
        background: #e52521; color: white; border: 2px solid white;
        font-size: 18px; cursor: pointer; border-radius: 30px;
        pointer-events: auto; transition: 0.2s;
        font-weight: bold;
    }
    .btn-load:hover { background: #ff4444; transform: scale(1.05); }
</style>

<div id="mario-wrapper">
    <div id="loading-mask">
        <h1 style="color:#ffce00; margin-bottom:10px; text-shadow: 2px 2px 0 #d32f2f;">GESTURE MARIO</h1>
        <p style="color:#ccc; font-size:14px; max-width:400px; line-height:1.6;">
            å·²æ£€æµ‹åˆ°æ¨¡å—ï¼š/modules/FullScreenMario/index.html<br>
            <span style="color:#e52521">æ³¨æ„ï¼šå¯åŠ¨åè¯·ç‚¹å‡»ä¸€ä¸‹æ¸¸æˆç”»é¢ä»¥è·å–ç„¦ç‚¹</span>
        </p>
        <div style="text-align:left; margin: 20px 0; background:#222; padding:20px; border-radius:8px; border:1px solid #444;">
            <div style="margin-bottom:8px">âœ‹ <b>æ‰‹è…•å€¾æ–œ</b> âœ <span style="color:cyan">å·¦å³ç§»åŠ¨</span></div>
            <div style="margin-bottom:8px">âœŠ <b>æ¡æ‹³</b> âœ <span style="color:orange">åŠ é€Ÿ/å¼€ç« (Shift)</span></div>
            <div>ğŸ‘Œ <b>æåˆæ‰‹æŒ‡</b> âœ <span style="color:yellow">è·³è·ƒ (Up/Space)</span></div>
        </div>
        <button class="btn-load" id="btn-inject-game">å¯åŠ¨æ¸¸æˆæ§åˆ¶</button>
    </div>

    <div class="overlay-ui">
        <div class="status-panel">
            <div style="margin-bottom:8px; border-bottom:1px solid #555; padding-bottom:5px;">CONTROL STATUS</div>
            <div class="status-item" id="st-left"><span class="key-badge">â†</span> LEFT</div>
            <div class="status-item" id="st-right"><span class="key-badge">â†’</span> RIGHT</div>
            <div class="status-item" id="st-run"><span class="key-badge">S</span> RUN/FIRE</div>
            <div class="status-item" id="st-jump"><span class="key-badge">â†‘</span> JUMP</div>
        </div>
        <div class="cam-box">
            <canvas id="debug-canvas"></canvas>
        </div>
    </div>

    <iframe id="game-iframe" src="about:blank" allow="autoplay; fullscreen; keyboard-map"></iframe>
    
    <video id="input-video" playsinline></video>
</div>

<script src="js/camera_utils.js"></script>
<script src="js/control_utils.js"></script>
<script src="js/drawing_utils.js"></script>
<script src="js/hands.js"></script>

<script>
(function() {
    // ================= 1. æ¸¸æˆé€‚é…é…ç½® =================
    // ä½ çš„æ¸¸æˆè·¯å¾„ (ç›¸å¯¹äºå½“å‰ modules æ–‡ä»¶å¤¹)
    // å®é™…è¯·æ±‚è·¯å¾„: ä½ çš„åŸŸå/modules/FullScreenMario/index.html
    const GAME_URL = "./modules/FullScreenMario-master/index.html"; 
    
    // FullScreenMario å¸¸ç”¨é”®ä½ç 
    // Left: 37, Up: 38, Right: 39, Down: 40
    // Shift: 16 (åŠ é€Ÿ/å¼€ç«), Space: 32 (è·³/æš‚åœ)
    const KEY_CODES = {
        LEFT: 37,
        RIGHT: 39,
        UP: 38,
        SPACE: 32,
        SHIFT: 16
    };

    // ================= 2. çŠ¶æ€ç®¡ç† =================
    const elements = {
        wrapper: document.getElementById('mario-wrapper'),
        iframe: document.getElementById('game-iframe'),
        video: document.getElementById('input-video'),
        canvas: document.getElementById('debug-canvas'),
        ctx: document.getElementById('debug-canvas').getContext('2d'),
        ui: {
            left: document.getElementById('st-left'),
            right: document.getElementById('st-right'),
            run: document.getElementById('st-run'),
            jump: document.getElementById('st-jump')
        }
    };

    // è®°å½•æŒ‰é”®çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤è§¦å‘ keydown
    const keyState = { 
        left: false, 
        right: false, 
        run: false, 
        jump: false 
    };

    // ================= 3. æ ¸å¿ƒï¼šæŒ‰é”®æ³¨å…¥å¼•æ“ =================
    // å…¼å®¹è€æ¸¸æˆï¼šåŒæ—¶å‘é€æ ‡å‡†çš„ KeyboardEvent å’Œæ—§å¼çš„ keyCode
    function triggerKey(action, isActive) {
        // çŠ¶æ€å»é‡ï¼šå¦‚æœçŠ¶æ€æ²¡å˜ï¼Œå°±ä¸é‡å¤å‘é€ (é™¤äº† Jump å¯èƒ½éœ€è¦è¿å‘ï¼Œä½†ä¸€èˆ¬é€šè¿‡é•¿æŒ‰å¤„ç†)
        if (keyState[action] === isActive) return;
        keyState[action] = isActive;

        // UI åé¦ˆ
        if(elements.ui[action]) {
            isActive ? elements.ui[action].classList.add('active') : elements.ui[action].classList.remove('active');
        }

        // è·å–ç›®æ ‡ Window
        const gameWin = elements.iframe.contentWindow;
        if (!gameWin) return;

        // æ˜ å°„åŠ¨ä½œåˆ°å…·ä½“çš„é”®ç åˆ—è¡¨ (æ”¯æŒä¸€ä¸ªåŠ¨ä½œè§¦å‘å¤šä¸ªé”®ï¼Œæ¯”å¦‚è·³è·ƒåŒæ—¶æŒ‰ Space å’Œ Up)
        let codes = [];
        if (action === 'left') codes = [KEY_CODES.LEFT];
        if (action === 'right') codes = [KEY_CODES.RIGHT];
        if (action === 'run') codes = [KEY_CODES.SHIFT];
        if (action === 'jump') codes = [KEY_CODES.UP, KEY_CODES.SPACE]; // åŒä¿é™©

        const eventType = isActive ? 'keydown' : 'keyup';

        codes.forEach(code => {
            // æ„é€ äº‹ä»¶ï¼šFullScreenMario è¿™ç§è€æ¸¸æˆéå¸¸ä¾èµ– keyCode å’Œ which
            const evt = new KeyboardEvent(eventType, {
                bubbles: true,
                cancelable: true,
                view: gameWin,
                keyCode: code, // å…³é”®ï¼šæ—§æ ‡å‡†
                which: code,   // å…³é”®ï¼šæ—§æ ‡å‡†
                code: getCodeName(code) // æ–°æ ‡å‡† (ArrowLeft ç­‰)
            });

            // æš´åŠ›æ´¾å‘ï¼šå‘ç»™ document å’Œ windowï¼Œç¡®ä¿æ¸¸æˆå¼•æ“èƒ½æ”¶åˆ°
            // å¾ˆå¤š Canvas æ¸¸æˆç›‘å¬çš„æ˜¯ window
            gameWin.document.dispatchEvent(evt);
            gameWin.dispatchEvent(evt);
            // å°è¯•å‘ç»™ body
            if(gameWin.document.body) gameWin.document.body.dispatchEvent(evt);
        });
    }

    // è¾…åŠ©ï¼šKeyCode è½¬ Code å­—ç¬¦ä¸² (ç°ä»£æµè§ˆå™¨éœ€è¦)
    function getCodeName(keyCode) {
        if(keyCode === 37) return 'ArrowLeft';
        if(keyCode === 38) return 'ArrowUp';
        if(keyCode === 39) return 'ArrowRight';
        if(keyCode === 40) return 'ArrowDown';
        if(keyCode === 32) return 'Space';
        if(keyCode === 16) return 'ShiftLeft';
        return '';
    }

    // ================= 4. æ‰‹åŠ¿è¯†åˆ«é€»è¾‘ =================
    
    function onResults(results) {
        if (!document.getElementById('mario-wrapper')) return; // é˜²å†…å­˜æ³„æ¼

        // ç»˜åˆ¶ Debug ç”»é¢
        const ctx = elements.ctx;
        const width = elements.canvas.width;
        const height = elements.canvas.height;

        ctx.save();
        ctx.clearRect(0, 0, width, height);
        ctx.drawImage(results.image, 0, 0, width, height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(ctx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

            // --- é€»è¾‘åˆ¤æ–­ ---
            
            // 1. ç§»åŠ¨ (æ‰‹è…•å€¾æ–œ)
            // æ¯”è¾ƒ [0]æ‰‹è…• å’Œ [9]ä¸­æŒ‡æ ¹ çš„ X åæ ‡
            const wrist = landmarks[0];
            const middleBase = landmarks[9];
            const tiltX = middleBase.x - wrist.x; 
            const TILT_THRES = 0.04; // é˜ˆå€¼

            // é•œåƒç”»é¢ï¼šç”»é¢ä¸­æ‰‹å‘å³æ­ª (tiltX > 0) -> å®é™…ä¸Šæ˜¯å‘å·¦è·‘
            // ä½†ç”¨æˆ·ä½“éªŒæ˜¯ï¼šçœ‹ç€å±å¹•ï¼Œæ‰‹å¾€å“ªè¾¹æ­ªï¼Œäººå¾€å“ªè¾¹è·‘
            // å±å¹•å³è¾¹æ˜¯ x å¢å¤§ã€‚
            // é•œåƒç¿»è½¬äº† scaleX(-1)ï¼Œæ‰€ä»¥ï¼š
            // çœŸå®å³æ‰‹å‘å³æ­ª -> æ‘„åƒå¤´ç”»é¢æ‰‹å‘å·¦ -> landmarks x å‡å° (ç›¸æ¯” wrist)
            // æˆ‘ä»¬ç›´æ¥çœ‹æ•°å€¼ï¼š
            
            if (tiltX < -TILT_THRES) { 
                // æ‰‹å‘å±å¹•å³ä¾§å€¾æ–œ (Right)
                triggerKey('right', true);
                triggerKey('left', false);
            } else if (tiltX > TILT_THRES) {
                // æ‰‹å‘å±å¹•å·¦ä¾§å€¾æ–œ (Left)
                triggerKey('left', true);
                triggerKey('right', false);
            } else {
                triggerKey('left', false);
                triggerKey('right', false);
            }

            // 2. åŠ é€Ÿ (æ¡æ‹³)
            // ç®€å•åˆ¤æ–­ï¼šæŒ‡å°–æ˜¯å¦éƒ½åœ¨æŒ‡æ ¹ä¸‹æ–¹ (yåæ ‡æ›´å¤§ï¼Œå› ä¸ºyå‘ä¸‹æ˜¯æ­£)
            // æˆ–è€…åˆ¤æ–­æŒ‡å°–ä¸æ‰‹è…•çš„è·ç¦»
            const isFist = (
                landmarks[8].y > landmarks[5].y && // é£ŸæŒ‡
                landmarks[12].y > landmarks[9].y && // ä¸­æŒ‡
                landmarks[16].y > landmarks[13].y    // æ— åæŒ‡
            );
            
            if (isFist) {
                triggerKey('run', true);
            } else {
                triggerKey('run', false);
            }

            // 3. è·³è·ƒ (æåˆ)
            // æ‹‡æŒ‡[4] å’Œ é£ŸæŒ‡[8]
            const dJump = Math.hypot(landmarks[4].x - landmarks[8].x, landmarks[4].y - landmarks[8].y);
            if (dJump < 0.05) {
                triggerKey('jump', true);
            } else {
                triggerKey('jump', false);
            }

        } else {
            // æ— æ‰‹åŠ¿ï¼Œé‡Šæ”¾æ‰€æœ‰é”®
            triggerKey('left', false);
            triggerKey('right', false);
            triggerKey('run', false);
            triggerKey('jump', false);
        }
        ctx.restore();
    }

    // ================= 5. åˆå§‹åŒ–æµç¨‹ =================
    
    document.getElementById('btn-inject-game').onclick = () => {
        // 1. éšè—é®ç½©
        document.getElementById('loading-mask').style.display = 'none';
        
        // 2. åŠ è½½æ¸¸æˆ
        // ä¸ºäº†é˜²æ­¢ç¼“å­˜å’Œç¡®ä¿åŠ è½½ï¼ŒåŠ ä¸ªæ—¶é—´æˆ³
        elements.iframe.src = GAME_URL;
        
        // 3. èšç„¦ (å…³é”®ï¼)
        elements.iframe.onload = () => {
            console.log("Mario Loaded. Focusing...");
            elements.iframe.contentWindow.focus();
            
            // å°è¯•æ¨¡æ‹Ÿä¸€æ¬¡ç‚¹å‡»ï¼Œæ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡
            const clickEvt = new MouseEvent('click', {
                view: elements.iframe.contentWindow,
                bubbles: true,
                cancelable: true
            });
            elements.iframe.contentDocument.body.dispatchEvent(clickEvt);
        };

        // 4. å¯åŠ¨ AI
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        hands.onResults(onResults);

        const cameraUtils = new Camera(elements.video, {
            onFrame: async () => { 
                if (!document.getElementById('mario-wrapper')) return; 
                await hands.send({image: elements.video}); 
            },
            width: 320, height: 240
        });
        cameraUtils.start();
    };

})();
</script>