<style>
    /* === æ¸¸æˆå®¹å™¨ === */
    #drone-wrapper {
        position: relative; width: 100%; height: 600px;
        background: #050510; /* æ·±ç©ºè“é»‘ */
        border-radius: 12px; overflow: hidden;
        border: 2px solid #334455;
        font-family: "Segoe UI", sans-serif;
        cursor: none; user-select: none;
        display: flex; justify-content: center; align-items: center;
    }

    /* æ¸¸æˆç”»å¸ƒ */
    canvas#game-canvas { 
        display: block; width: 100%; height: 100%; 
        position: absolute; top: 0; left: 0; z-index: 1;
    }

    /* === UI è¦†ç›–å±‚ === */
    .overlay-ui {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; display: flex; flex-direction: column;
        padding: 20px; box-sizing: border-box; z-index: 10;
    }

    /* çŠ¶æ€æŒ‡ç¤ºå™¨ (è¯Šæ–­) */
    .status-pill {
        position: absolute; top: 20px; left: 20px;
        display: inline-block; padding: 6px 12px;
        background: rgba(0, 0, 0, 0.6); 
        border: 1px solid rgba(0, 255, 0, 0.5);
        border-radius: 4px; backdrop-filter: blur(5px);
        font-size: 12px; color: #00ff00;
        pointer-events: auto;
    }

    /* æ‘„åƒå¤´ç”»ä¸­ç”» (å®Œå…¨ç…§æ¬ mario.html) */
    .cam-box {
        position: absolute; bottom: 20px; right: 20px;
        width: 160px; height: 120px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 8px; background: #000;
        overflow: hidden;
        transform: scaleX(-1); /* é•œåƒ */
        z-index: 999; /* ç¡®ä¿æœ€é«˜å±‚çº§ */
        pointer-events: auto;
    }
    #debug-canvas { width: 100%; height: 100%; object-fit: cover; }
    
    /* â˜…â˜…â˜… å…³é”®ï¼šå®Œå…¨ç…§æ¬ Mario çš„éšè—æ–¹å¼ â˜…â˜…â˜… */
    #input-video { display: none; }

    /* HUD */
    .hud-bar {
        display: flex; justify-content: flex-end; align-items: flex-start;
        text-shadow: 0 0 10px rgba(0,255,255,0.8); gap: 20px; margin-top: 40px; /* é¿å¼€çŠ¶æ€æ¡ */
    }
    .score-box { font-size: 28px; color: #ffcc00; font-weight: bold; }
    
    /* èœå•å±å¹• */
    .center-screen {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        text-align: center; color: white; background: rgba(0,0,0,0.85);
        padding: 50px; border-radius: 16px; border: 1px solid #00ffff;
        box-shadow: 0 0 50px rgba(0, 255, 255, 0.15);
        display: none; pointer-events: auto; z-index: 30;
    }
    .center-screen.active { display: block; animation: fadeIn 0.3s; }
    
    .title { font-size: 64px; color: #fff; font-weight: 900; letter-spacing: 6px; margin-bottom: 20px; text-shadow: 0 0 20px #00ffff; }
    .btn {
        background: linear-gradient(180deg, #ffcc00, #ffaa00); color: #000;
        border: none; padding: 15px 50px; font-size: 24px; font-weight: bold;
        border-radius: 50px; cursor: pointer; margin-top: 30px;
        transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.95); }

    /* æš‚åœé®ç½© */
    #pause-tip {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: #ff3333; font-size: 24px; font-weight: bold;
        background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
        opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 25;
    }
    #pause-tip.visible { opacity: 1; }

    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -40%); } to { opacity: 1; transform: translate(-50%, -50%); } }
</style>

<div id="drone-wrapper">
    <canvas id="game-canvas"></canvas>

    <div class="overlay-ui">
        <div id="status-text" class="status-pill">1. ç­‰å¾…åˆå§‹åŒ–...</div>

        <div class="hud-bar">
            <div class="score-box">SCORE: <span id="ui-score">0</span></div>
            <div style="text-align:right">
                <div style="font-size:12px; color:#0f0">SHIELD</div>
                <div style="width:200px; height:10px; background:#333; border:1px solid #666; border-radius:5px; overflow:hidden;">
                    <div id="ui-hp" style="width:100%; height:100%; background:linear-gradient(90deg, #00ff88, #00ffff); transition:width 0.1s;"></div>
                </div>
            </div>
        </div>

        <div class="cam-box">
            <canvas id="debug-canvas"></canvas>
        </div>
    </div>

    <div id="pause-tip">âš ï¸ ä¿¡å·ä¸¢å¤± - è¯·æŠŠæ‰‹ç§»å›å±å¹•</div>

    <div id="start-screen" class="center-screen active">
        <div class="title">NEO WAR</div>
        <p style="color:#ccc; font-size:16px;">ğŸ–ï¸ å¼ æ‰‹ç§»åŠ¨ | âœŠ æ¡æ‹³(é¢„ç•™)<br>è¯·ç¡®ä¿æ‘„åƒå¤´å°çª—å·²æ˜¾ç¤ºç”»é¢</p>
        <button class="btn" onclick="window.game.start()">START GAME</button>
    </div>

    <div id="gameover-screen" class="center-screen">
        <h1 style="color:#ff3333;">MISSION FAILED</h1>
        <p style="font-size:20px;">FINAL SCORE: <span id="final-score" style="color:#ffcc00">0</span></p>
        <button class="btn" onclick="window.game.restart()">RETRY</button>
    </div>

    <video id="input-video" playsinline></video>
</div>

<script src="js/camera_utils.js"></script>
<script src="js/control_utils.js"></script>
<script src="js/drawing_utils.js"></script>
<script src="js/hands.js"></script>

<script>
(function() {
    // ================= 1. æ¸¸æˆå¼•æ“ (ä¿ç•™ä½ çš„ç©ºæˆ˜é€»è¾‘) =================
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('drone-wrapper');
    const statusText = document.getElementById('status-text');

    function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // èµ„æºç”Ÿæˆ (Canvasç»˜å›¾)
    const Assets = {
        player: (() => {
            const c = document.createElement('canvas'); c.width=64; c.height=64; const x=c.getContext('2d');
            x.shadowBlur=15; x.shadowColor='#00aaff';
            x.fillStyle='#00aaff'; x.beginPath(); x.moveTo(32,0); x.lineTo(60,50); x.lineTo(32,40); x.lineTo(4,50); x.fill();
            x.shadowBlur=0; x.fillStyle='#fff'; x.fillRect(30,20,4,10);
            return c;
        })(),
        enemy_speeder: (() => {
            const c = document.createElement('canvas'); c.width=40; c.height=40; const x=c.getContext('2d');
            x.shadowBlur=10; x.shadowColor='#ff3333'; x.fillStyle='#ff3333'; 
            x.beginPath(); x.moveTo(20,40); x.lineTo(40,0); x.lineTo(20,10); x.lineTo(0,0); x.fill();
            return c;
        })(),
        enemy_shooter: (() => {
            const c = document.createElement('canvas'); c.width=50; c.height=50; const x=c.getContext('2d');
            x.shadowBlur=10; x.shadowColor='#ffaa00'; x.fillStyle='#ffaa00'; 
            x.fillRect(15,0,20,30); x.fillRect(5,10,40,10);
            return c;
        })(),
        enemy_carrier: (() => {
            const c = document.createElement('canvas'); c.width=80; c.height=80; const x=c.getContext('2d');
            x.shadowBlur=15; x.shadowColor='#aa00ff'; x.fillStyle='#aa00ff'; 
            x.fillRect(20,5,40,70); x.fillStyle='#cc55ff'; x.fillRect(5,20,15,40); x.fillRect(60,20,15,40);
            return c;
        })()
    };

    class Game {
        constructor() {
            this.state = 'MENU';
            this.score = 0;
            this.frames = 0;
            this.player = { x: canvas.width/2, y: canvas.height-100, w: 50, h: 50, hp: 100, speed: 0.2 };
            this.handTarget = { x: canvas.width/2, y: canvas.height-100 };
            this.hasHand = false;
            
            this.bullets = []; this.ebullets = []; this.enemies = []; this.particles = [];
            this.stars = Array(100).fill().map(() => ({ x:Math.random()*canvas.width, y:Math.random()*canvas.height, size:Math.random()*2, speed:Math.random()*3+1 }));
        }

        start() {
            this.state = 'PLAYING';
            this.reset();
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('gameover-screen').classList.remove('active');
            this.loop();
        }

        restart() { this.start(); }

        reset() {
            this.score = 0; this.player.hp = 100;
            this.bullets = []; this.ebullets = []; this.enemies = []; this.particles = [];
            this.updateUI();
        }

        update() {
            if (!this.hasHand) {
                document.getElementById('pause-tip').classList.add('visible');
                return;
            }
            document.getElementById('pause-tip').classList.remove('visible');

            // ç©å®¶ç§»åŠ¨
            const dx = this.handTarget.x - this.player.x;
            const dy = this.handTarget.y - this.player.y;
            this.player.x += dx * this.player.speed;
            this.player.y += dy * this.player.speed;
            this.player.x = Math.max(30, Math.min(canvas.width-30, this.player.x));
            this.player.y = Math.max(30, Math.min(canvas.height-30, this.player.y));

            // ç²’å­å°¾ç„°
            if(this.frames % 3 === 0) this.spawnParticle(this.player.x, this.player.y+25, '#00aaff', 3, 1);

            // å°„å‡»
            if (this.frames % 8 === 0) {
                this.bullets.push({x:this.player.x, y:this.player.y-30, vx:0, vy:-15, w:4, h:20, c:'#ffff00'});
                this.bullets.push({x:this.player.x-20, y:this.player.y, vx:-1, vy:-12, w:3, h:10, c:'#00ffff'});
                this.bullets.push({x:this.player.x+20, y:this.player.y, vx:1, vy:-12, w:3, h:10, c:'#00ffff'});
            }

            // ç”Ÿæˆæ•Œäºº
            if (this.frames % 50 === 0) this.spawnEnemy();

            this.updateEntities();
            this.frames++;
        }

        spawnEnemy() {
            const r = Math.random();
            const x = Math.random() * (canvas.width - 60) + 30;
            if (r < 0.5) this.enemies.push({type:'speeder', x:x, y:-40, w:40, h:40, hp:3, img:Assets.enemy_speeder, vx:0, vy:5, t:0});
            else if (r < 0.8) this.enemies.push({type:'shooter', x:x, y:-50, w:50, h:50, hp:6, img:Assets.enemy_shooter, vx:0, vy:2, lastShot:this.frames});
            else this.enemies.push({type:'carrier', x:x, y:-80, w:80, h:80, hp:20, img:Assets.enemy_carrier, vx:0, vy:1});
        }

        updateEntities() {
            // å­å¼¹æ›´æ–°
            this.bullets.forEach(b => { b.x+=b.vx; b.y+=b.vy; });
            this.bullets = this.bullets.filter(b => b.y > -50);
            this.ebullets.forEach(b => { b.x+=b.vx; b.y+=b.vy; });
            this.ebullets = this.ebullets.filter(b => b.y < canvas.height+50);

            // ç¢°æ’ä¸é€»è¾‘
            this.enemies.forEach((e, i) => {
                // ç§»åŠ¨
                if(e.type==='speeder') { e.t+=0.1; e.x+=Math.sin(e.t)*4; e.y+=e.vy; }
                else { e.y+=e.vy; }

                // å°„å‡»
                if(e.type==='shooter' && (this.frames-e.lastShot>100)) {
                    const angle = Math.atan2(this.player.y-e.y, this.player.x-e.x);
                    this.ebullets.push({x:e.x, y:e.y+20, vx:Math.cos(angle)*5, vy:Math.sin(angle)*5, w:8, h:8, c:'#ff3333'});
                    e.lastShot = this.frames;
                }

                // ç©å®¶å­å¼¹å‡»ä¸­æ•Œäºº
                this.bullets.forEach((b, bi) => {
                    if(b.active!==false && this.checkCollide(b, e)) {
                        b.active = false; e.hp--;
                        this.spawnParticle(b.x, b.y, '#00ffff', 2, 3);
                        if(e.hp<=0) {
                            this.enemies.splice(i, 1);
                            this.score += (e.type==='carrier'?500:100);
                            this.spawnParticle(e.x, e.y, '#ffaa00', 5, 10);
                            this.updateUI();
                        }
                    }
                });

                // æ’å‡»ç©å®¶
                if(this.checkCollide(e, this.player)) {
                    this.enemies.splice(i, 1);
                    this.playerDamage(20);
                    this.spawnParticle(e.x, e.y, '#ff0000', 5, 10);
                }
            });
            this.enemies = this.enemies.filter(e => e.y < canvas.height+50 && e.hp > 0);
            this.bullets = this.bullets.filter(b => b.active!==false);

            // æ•Œå¼¹å‡»ä¸­ç©å®¶
            this.ebullets.forEach((b, i) => {
                if(this.checkCollide(b, this.player)) {
                    this.ebullets.splice(i, 1);
                    this.playerDamage(10);
                }
            });

            // ç²’å­ä¸èƒŒæ™¯
            this.particles.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.life-=0.05; });
            this.particles = this.particles.filter(p => p.life > 0);
            this.stars.forEach(s => { s.y+=s.speed; if(s.y>canvas.height) s.y=0; });

            if(this.player.hp<=0) this.gameOver();
        }

        playerDamage(dmg) {
            this.player.hp -= dmg;
            this.spawnParticle(this.player.x, this.player.y, '#ff0000', 4, 10);
            // éœ‡å±
            canvas.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
            setTimeout(() => canvas.style.transform = 'none', 50);
            this.updateUI();
        }

        spawnParticle(x, y, c, s, count) {
            for(let i=0; i<count; i++) {
                this.particles.push({x:x, y:y, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, life:1, color:c, size:Math.random()*s});
            }
        }

        checkCollide(a, b) {
            return Math.abs(a.x-b.x) < (a.w+b.w)/2.5 && Math.abs(a.y-b.y) < (a.h+b.h)/2.5;
        }

        updateUI() {
            document.getElementById('ui-score').innerText = this.score;
            document.getElementById('ui-hp').style.width = Math.max(0, this.player.hp) + "%";
        }

        gameOver() {
            this.state = 'GAMEOVER';
            document.getElementById('final-score').innerText = this.score;
            document.getElementById('gameover-screen').classList.add('active');
        }

        draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ˜Ÿç©º
            ctx.fillStyle = '#fff';
            this.stars.forEach(s => { ctx.globalAlpha=Math.random(); ctx.fillRect(s.x, s.y, s.size, s.size); });
            ctx.globalAlpha = 1;

            if (this.state === 'PLAYING') {
                ctx.drawImage(Assets.player, this.player.x-32, this.player.y-32);
                
                // å­å¼¹ (å‘å…‰)
                ctx.shadowBlur = 10;
                this.bullets.forEach(b => { ctx.shadowColor=b.c; ctx.fillStyle=b.c; ctx.fillRect(b.x-b.w/2, b.y-b.h/2, b.w, b.h); });
                this.ebullets.forEach(b => { ctx.shadowColor=b.c; ctx.fillStyle=b.c; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
                ctx.shadowBlur = 0;

                this.enemies.forEach(e => ctx.drawImage(e.img, e.x-e.w/2, e.y-e.h/2));
                
                this.particles.forEach(p => {
                    ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                });
                ctx.globalAlpha = 1;
            }
        }

        loop() {
            if(this.state === 'PLAYING') {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
        }
    }

    window.game = new Game();

    // ================= 2. æ‘„åƒå¤´ä¸AI (100% ç…§æ¬ mario.html) =================
    const elements = {
        wrapper: document.getElementById('drone-wrapper'),
        video: document.getElementById('input-video'),
        canvas: document.getElementById('debug-canvas'),
        ctx: document.getElementById('debug-canvas').getContext('2d')
    };

    function onResults(results) {
        if (!document.getElementById('drone-wrapper')) return;

        // çŠ¶æ€åé¦ˆ
        if(statusText.innerText.includes("åˆå§‹åŒ–")) {
            statusText.innerText = "ç³»ç»Ÿå°±ç»ªï¼šè¯·å±•ç¤ºæ‰‹æŒ";
            statusText.style.color = "#00ff00";
            statusText.style.borderColor = "#00ff00";
        }

        // ç»˜åˆ¶å°çª—
        elements.ctx.save();
        elements.ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
        elements.ctx.drawImage(results.image, 0, 0, elements.canvas.width, elements.canvas.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            drawConnectors(elements.ctx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(elements.ctx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

            // æ˜ å°„åæ ‡
            const cx = landmarks[9].x; 
            const cy = landmarks[9].y;
            
            window.game.handTarget.x = (1 - cx) * canvas.width;
            window.game.handTarget.y = cy * canvas.height;
            window.game.hasHand = true;
        } else {
            window.game.hasHand = false;
        }
        elements.ctx.restore();
    }

    // æ­¥éª¤1
    statusText.innerText = "1. æ­£åœ¨åŠ è½½ AI æ¨¡å‹...";
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
    hands.onResults(onResults);

    // æ­¥éª¤2
    statusText.innerText = "2. æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
    const cameraUtils = new Camera(elements.video, {
        onFrame: async () => { 
            if (!document.getElementById('drone-wrapper')) return; 
            await hands.send({image: elements.video}); 
        },
        width: 320, height: 240
    });
    cameraUtils.start().catch(e => {
        statusText.innerText = "âŒ æ‘„åƒå¤´é”™è¯¯: " + e;
        statusText.style.background = "red";
    });

})();
</script>