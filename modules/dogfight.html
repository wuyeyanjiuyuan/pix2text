<style>
    /* === æ¸¸æˆä¸»å®¹å™¨ (ä»¿ç…§ mario-wrapper) === */
    #drone-wrapper {
        position: relative; width: 100%; height: 600px;
        background: #000; border-radius: 12px; overflow: hidden;
        border: 2px solid #333;
        font-family: "Segoe UI", sans-serif;
        cursor: none; user-select: none;
        display: flex; justify-content: center; align-items: center;
    }

    /* æ¸¸æˆç”»å¸ƒ */
    canvas#game-canvas { 
        display: block; width: 100%; height: 100%; 
        position: absolute; top: 0; left: 0; z-index: 1;
    }

    /* === UI è¦†ç›–å±‚ (ä»¿ç…§ overlay-ui) === */
    .overlay-ui {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; display: flex; flex-direction: column;
        padding: 20px; box-sizing: border-box; z-index: 10;
    }

    /* æ‘„åƒå¤´å°çª— (å®Œå…¨ç…§æ¬ mario.html) */
    .cam-box {
        position: absolute; bottom: 20px; right: 20px;
        width: 160px; height: 120px;
        border: 3px solid rgba(255,255,255,0.5);
        border-radius: 8px; background: #000;
        overflow: hidden;
        transform: scaleX(-1); /* é•œåƒ */
        z-index: 20;
        pointer-events: auto; /* å…è®¸ç‚¹å‡»æµ‹è¯• */
    }
    #debug-canvas { width: 100%; height: 100%; object-fit: cover; }
    
    /* å…³é”®ï¼šé©¬é‡Œå¥¥åŒæ¬¾è§†é¢‘éšè—æ–¹å¼ */
    #input-video { display: none; }

    /* HUD å’Œ èœå•æ ·å¼ */
    .hud-bar { display: flex; justify-content: space-between; text-shadow: 0 2px 4px #000; color: #fff; }
    .score { font-size: 24px; color: #ffcc00; font-weight: bold; }
    
    .center-screen {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        text-align: center; color: white; background: rgba(0,0,0,0.9);
        padding: 40px; border-radius: 16px; border: 2px solid #00ffff;
        display: none; pointer-events: auto; z-index: 30;
    }
    .center-screen.active { display: block; }
    .btn {
        background: #ffcc00; color: #000; border: none; padding: 10px 30px;
        font-size: 18px; font-weight: bold; border-radius: 30px; cursor: pointer;
        margin-top: 20px;
    }

    /* æš‚åœé®ç½© */
    #pause-tip {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: #ff3333; font-size: 24px; font-weight: bold;
        background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px;
        opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 25;
    }
    #pause-tip.visible { opacity: 1; }
</style>

<div id="drone-wrapper">
    <canvas id="game-canvas"></canvas>

    <div class="overlay-ui">
        <div class="hud-bar">
            <div class="score">SCORE: <span id="ui-score">0</span></div>
            <div style="text-align:right">
                <div style="font-size:12px; color:#0f0">SHIELD</div>
                <div style="width:150px; height:10px; background:#333; border:1px solid #666;">
                    <div id="ui-hp" style="width:100%; height:100%; background:#0f0; transition:width 0.2s;"></div>
                </div>
            </div>
        </div>

        <div class="cam-box">
            <canvas id="debug-canvas"></canvas>
        </div>
    </div>

    <div id="pause-tip">âš ï¸ ä¿¡å·ä¸¢å¤± - è¯·æŠŠæ‰‹ç§»å›å±å¹•</div>

    <div id="start-screen" class="center-screen active">
        <h1 style="color:#00ffff; margin-bottom:10px;">NEO RAIDEN</h1>
        <p style="color:#ccc;">ğŸ–ï¸ å¼ æ‰‹ç§»åŠ¨ | âœŠ æ¡æ‹³(æœªå®è£…)</p>
        <button class="btn" onclick="game.start()">START GAME</button>
    </div>

    <div id="gameover-screen" class="center-screen">
        <h1 style="color:#ff3333;">MISSION FAILED</h1>
        <p>SCORE: <span id="final-score">0</span></p>
        <button class="btn" onclick="game.restart()">RETRY</button>
    </div>

    <video id="input-video" playsinline></video>
</div>

<script src="js/camera_utils.js"></script>
<script src="js/control_utils.js"></script>
<script src="js/drawing_utils.js"></script>
<script src="js/hands.js"></script>

<script>
(function() {
    // ================= 1. æ¸¸æˆå¼•æ“ (Canvas 2D) =================
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('drone-wrapper');

    function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // èµ„æºç”Ÿæˆ (Canvasç»˜å›¾ï¼Œæ— å¤–éƒ¨å›¾ç‰‡)
    const Assets = {
        player: (() => {
            const c = document.createElement('canvas'); c.width=64; c.height=64; const x=c.getContext('2d');
            x.fillStyle='#ccc'; x.beginPath(); x.moveTo(32,10); x.lineTo(62,55); x.lineTo(2,55); x.fill();
            x.fillStyle='#00aaff'; x.fillRect(28,5,8,50);
            x.fillStyle='#ffaa00'; x.fillRect(29,55,6,5);
            return c;
        })(),
        enemy_basic: (() => {
            const c = document.createElement('canvas'); c.width=40; c.height=40; const x=c.getContext('2d');
            x.fillStyle='#ff4444'; x.beginPath(); x.moveTo(20,38); x.lineTo(38,2); x.lineTo(20,10); x.lineTo(2,2); x.fill();
            return c;
        })(),
        enemy_shooter: (() => { // å¤æ‚æ•Œäººï¼šå°„å‡»å‹
            const c = document.createElement('canvas'); c.width=50; c.height=50; const x=c.getContext('2d');
            x.fillStyle='#ff8800'; x.fillRect(15,0,20,45); x.fillRect(2,10,46,15); 
            x.fillStyle='#550000'; x.fillRect(22,35,6,6);
            return c;
        })()
    };

    class Game {
        constructor() {
            this.state = 'MENU';
            this.score = 0;
            this.frames = 0;
            this.player = { x: canvas.width/2, y: canvas.height-100, w: 50, h: 50, hp: 100 };
            this.handTarget = { x: canvas.width/2, y: canvas.height-100 };
            this.hasHand = false;
            
            this.bullets = [];
            this.ebullets = []; // æ•Œæ–¹å­å¼¹
            this.enemies = [];
            this.particles = [];
            
            // æ˜Ÿç©ºèƒŒæ™¯
            this.stars = Array(80).fill().map(() => ({
                x: Math.random()*canvas.width, y: Math.random()*canvas.height,
                size: Math.random()*2, speed: Math.random()*3+1
            }));
        }

        start() {
            this.state = 'PLAYING';
            this.score = 0;
            this.player.hp = 100;
            this.bullets = []; this.ebullets = []; this.enemies = []; this.particles = [];
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('gameover-screen').classList.remove('active');
            this.loop();
        }

        restart() { this.start(); }

        update() {
            if (!this.hasHand) {
                document.getElementById('pause-tip').classList.add('visible');
                return; // æš‚åœ
            }
            document.getElementById('pause-tip').classList.remove('visible');

            // 1. ç©å®¶ç§»åŠ¨ (è·Ÿéšæ‰‹åŠ¿)
            const dx = this.handTarget.x - this.player.x;
            const dy = this.handTarget.y - this.player.y;
            this.player.x += dx * 0.15;
            this.player.y += dy * 0.15;
            
            // 2. å°„å‡»
            if (this.frames % 8 === 0) {
                this.bullets.push({x: this.player.x, y: this.player.y-30, vx:0, vy:-12, w:6, h:20});
                this.bullets.push({x: this.player.x-15, y: this.player.y-10, vx:-1, vy:-12, w:4, h:15}); // ä¾§ç‚®
                this.bullets.push({x: this.player.x+15, y: this.player.y-10, vx:1, vy:-12, w:4, h:15});
            }

            // 3. ç”Ÿæˆæ•Œäºº (å¤æ‚é€»è¾‘)
            if (this.frames % 50 === 0) {
                const type = Math.random() > 0.5 ? 'basic' : 'shooter';
                this.enemies.push({
                    type: type,
                    x: Math.random() * (canvas.width-40) + 20,
                    y: -50, w: 40, h: 40,
                    hp: type === 'basic' ? 3 : 6,
                    img: type === 'basic' ? Assets.enemy_basic : Assets.enemy_shooter,
                    vx: 0, vy: type === 'basic' ? 4 : 2,
                    t: 0, // ç”¨äºæ­£å¼¦è¿åŠ¨
                    lastShot: this.frames
                });
            }

            // 4. æ›´æ–°å®ä½“
            this.updateEntities();
            this.frames++;
        }

        updateEntities() {
            // å­å¼¹
            this.bullets.forEach(b => { b.x+=b.vx; b.y+=b.vy; });
            this.bullets = this.bullets.filter(b => b.y > -50);

            // æ•Œæ–¹å­å¼¹
            this.ebullets.forEach(b => { b.x+=b.vx; b.y+=b.vy; });
            this.ebullets = this.ebullets.filter(b => b.y < canvas.height+50);
            
            // æ’å‡»æ£€æµ‹ï¼šæ•Œå¼¹æ’ç©å®¶
            this.ebullets.forEach((b, i) => {
                if (this.checkCollide(b, this.player)) {
                    this.player.hp -= 10;
                    this.createExplosion(b.x, b.y, 5, '#ff0000');
                    this.ebullets.splice(i, 1);
                    this.updateUI();
                }
            });

            // æ•Œäºº
            this.enemies.forEach((e, i) => {
                // ç§»åŠ¨é€»è¾‘
                if (e.type === 'basic') {
                    e.t += 0.1;
                    e.x += Math.sin(e.t) * 3; // è›‡å½¢èµ°ä½
                    e.y += e.vy;
                } else {
                    e.y += e.vy;
                    // å°„å‡»é€»è¾‘
                    if (this.frames - e.lastShot > 100) {
                        const angle = Math.atan2(this.player.y - e.y, this.player.x - e.x);
                        this.ebullets.push({
                            x: e.x, y: e.y+20, w:8, h:8,
                            vx: Math.cos(angle)*5, vy: Math.sin(angle)*5
                        });
                        e.lastShot = this.frames;
                    }
                }

                // ç©å®¶å­å¼¹æ‰“æ•Œäºº
                this.bullets.forEach((b, bi) => {
                    if (this.checkCollide(b, e)) {
                        e.hp--;
                        this.bullets.splice(bi, 1);
                        this.createExplosion(b.x, b.y, 3, '#00ffff');
                        if (e.hp <= 0) {
                            this.enemies.splice(i, 1);
                            this.score += 100;
                            this.createExplosion(e.x, e.y, 20, '#ffaa00');
                            this.updateUI();
                        }
                    }
                });
            });
            this.enemies = this.enemies.filter(e => e.y < canvas.height + 50 && e.hp > 0);

            // ç²’å­
            this.particles.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.life-=0.05; });
            this.particles = this.particles.filter(p => p.life > 0);

            // èƒŒæ™¯
            this.stars.forEach(s => { s.y += s.speed; if(s.y > canvas.height) s.y=0; });

            // æ­»äº¡æ£€æµ‹
            if (this.player.hp <= 0) {
                this.state = 'GAMEOVER';
                document.getElementById('final-score').innerText = this.score;
                document.getElementById('gameover-screen').classList.add('active');
            }
        }

        checkCollide(a, b) {
            // ç®€å•çŸ©å½¢ç¢°æ’ (ç¨å¾®ç¼©å°åˆ¤å®šæ¡†)
            return Math.abs(a.x - b.x) < 30 && Math.abs(a.y - b.y) < 30;
        }

        createExplosion(x, y, size, color) {
            for(let i=0; i<8; i++) {
                this.particles.push({
                    x, y, 
                    vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 1, color: color, size: Math.random()*size
                });
            }
        }

        updateUI() {
            document.getElementById('ui-score').innerText = this.score;
            document.getElementById('ui-hp').style.width = Math.max(0, this.player.hp) + "%";
        }

        draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æ˜Ÿç©º
            ctx.fillStyle = '#fff';
            this.stars.forEach(s => { 
                ctx.globalAlpha = Math.random(); 
                ctx.fillRect(s.x, s.y, s.size, s.size); 
            });
            ctx.globalAlpha = 1;

            if (this.state === 'PLAYING') {
                // ç©å®¶
                ctx.drawImage(Assets.player, this.player.x-32, this.player.y-32);
                // æ•Œäºº
                this.enemies.forEach(e => ctx.drawImage(e.img, e.x-e.w/2, e.y-e.h/2));
                // å­å¼¹
                ctx.fillStyle = '#00ffff';
                this.bullets.forEach(b => ctx.fillRect(b.x-b.w/2, b.y-b.h/2, b.w, b.h));
                ctx.fillStyle = '#ff0000';
                this.ebullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
                // ç²’å­
                this.particles.forEach(p => {
                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                });
                ctx.globalAlpha = 1;
            }
        }

        loop() {
            if (this.state === 'PLAYING') {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
        }
    }

    const game = new Game();

    // ================= 2. æ‘„åƒå¤´ä¸AI (é©¬é‡Œå¥¥åŒæ¬¾é€»è¾‘) =================
    const elements = {
        wrapper: document.getElementById('drone-wrapper'),
        video: document.getElementById('input-video'),
        canvas: document.getElementById('debug-canvas'),
        ctx: document.getElementById('debug-canvas').getContext('2d')
    };

    function onResults(results) {
        // å®‰å…¨æ£€æµ‹ï¼šå¦‚æœé¡µé¢åˆ‡èµ°äº†ï¼Œå°±åœæ­¢æ¸²æŸ“
        if (!document.getElementById('drone-wrapper')) return;

        // 1. ç»˜åˆ¶æ‘„åƒå¤´ç”»é¢åˆ°å³ä¸‹è§’å°çª—
        elements.ctx.save();
        elements.ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
        elements.ctx.drawImage(results.image, 0, 0, elements.canvas.width, elements.canvas.height);

        // 2. è¯†åˆ«æ‰‹åŠ¿
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // ç”»éª¨æ¶
            drawConnectors(elements.ctx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(elements.ctx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

            // è·å–åæ ‡ (ä¸­æŒ‡æ ¹éƒ¨)
            const cx = landmarks[9].x; 
            const cy = landmarks[9].y;

            // æ˜ å°„åˆ°æ¸¸æˆ (æ³¨æ„ x æ˜¯é•œåƒçš„: 1-cx)
            game.handTarget.x = (1 - cx) * canvas.width;
            game.handTarget.y = cy * canvas.height;
            game.hasHand = true;
        } else {
            game.hasHand = false;
        }
        elements.ctx.restore();
    }

    // â˜…â˜…â˜… å¯åŠ¨é€»è¾‘ï¼šå®Œå…¨ç…§æ¬ mario.html â˜…â˜…â˜…
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    const cameraUtils = new Camera(elements.video, {
        onFrame: async () => { 
            if (!document.getElementById('drone-wrapper')) return; // é˜²å†…å­˜æ³„æ¼
            await hands.send({image: elements.video}); 
        },
        width: 320, height: 240
    });
    cameraUtils.start();

})();
</script>