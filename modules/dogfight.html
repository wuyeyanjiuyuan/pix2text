<style>
    /* === æ¸¸æˆå®¹å™¨ä¸åŸºç¡€å±‚ === */
    #drone-container {
        position: relative; width: 100%; height: 600px;
        background: #111; border-radius: 12px; overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        font-family: 'Courier New', Courier, monospace; /* å¤å¤å­—ä½“ */
        user-select: none;
    }
    #game-canvas { width: 100%; height: 100%; display: block; position: absolute; z-index: 1; }
    
    /* === UI è¦†ç›–å±‚ (èœå•/HUD) === */
    .ui-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 10; pointer-events: none;
        display: flex; flex-direction: column;
        text-shadow: 2px 2px 0px #000;
    }
    
    /* é€šç”¨æŒ‰é’®/é€‰é¡¹æ ·å¼ */
    .menu-item {
        background: rgba(0,0,0,0.6); color: #fff;
        padding: 15px 30px; margin: 10px; border: 2px solid #555;
        font-size: 24px; font-weight: bold; width: 300px; text-align: center;
        transform: skewX(-10deg); transition: all 0.2s;
        opacity: 0.7;
    }
    .menu-item.active {
        background: #ffcc00; color: #000; border-color: #fff;
        opacity: 1; transform: skewX(-10deg) scale(1.1);
        box-shadow: 0 0 15px #ffcc00;
    }

    /* å„ä¸ªç•Œé¢å®¹å™¨ */
    #screen-start, #screen-shop, #screen-upgrade, #screen-gameover {
        position: absolute; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        transition: opacity 0.3s;
    }
    .hidden { opacity: 0; pointer-events: none; display: none !important; }

    /* æ ‡é¢˜ */
    h1.game-title {
        font-size: 60px; color: #00ddee; 
        text-transform: uppercase; letter-spacing: 5px;
        margin-bottom: 50px;
        text-shadow: 4px 4px 0 #ff00de;
    }

    /* å•†åº—/å‡çº§ åˆ—è¡¨ */
    .grid-panel {
        display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        max-width: 800px; max-height: 400px; overflow-y: auto;
        padding: 20px;
    }
    .shop-card {
        background: #222; border: 2px solid #444; padding: 15px;
        display: flex; flex-direction: column; align-items: center;
        color: #ddd; font-size: 14px;
    }
    .shop-card.owned { border-color: #00ff00; color: #88ff88; }
    .shop-card.active { border-color: #ffcc00; background: #333; }
    
    /* æ¸¸æˆå†… HUD */
    #hud-layer {
        position: absolute; top: 0; left: 0; width: 100%; padding: 20px;
        display: flex; justify-content: space-between;
        font-size: 20px; color: #fff; font-weight: bold;
    }
    #pause-overlay {
        position: absolute; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.7); color: yellow;
        display: flex; align-items: center; justify-content: center;
        font-size: 30px; letter-spacing: 2px;
        backdrop-filter: blur(5px);
    }

    /* æ‘„åƒå¤´å°çª— */
    .cam-box {
        position: absolute; bottom: 10px; right: 10px;
        width: 120px; height: 90px; border: 2px solid #444; 
        z-index: 20; background: #000; overflow: hidden; opacity: 0.6;
    }
    #input-video { position: absolute; opacity: 0; pointer-events: none; }
    #output-canvas { width: 100%; height: 100%; transform: scaleX(-1); }
</style>

<div id="drone-container">
    <div id="game-canvas"></div>

    <div class="ui-layer">
        
        <div id="screen-start">
            <h1 class="game-title">SKY FORCE</h1>
            <div class="menu-item active" id="btn-start">å¼€å§‹å‡ºå‡»</div>
            <div class="menu-item" id="btn-shop">å†›ç«å•†åº—</div>
            <div class="menu-item" id="btn-upgrade">æœºä½“æ”¹é€ </div>
            <div style="margin-top:40px; color:#aaa; font-size:12px;">
                ğŸ–ï¸ å¼ æ‰‹æ‘‡æ†é€‰æ‹© | âœŠ æ¡æ‹³ç¡®è®¤è¿›å…¥
            </div>
        </div>

        <div id="screen-shop" class="hidden">
            <h2>å†›ç«å•†åº— (é‡‘å¸: <span class="gold-display">0</span>)</h2>
            <div class="grid-panel" id="shop-list">
                </div>
            <div class="menu-item active" style="margin-top:auto">è¿”å›ä¸»é¡µ</div>
        </div>

        <div id="screen-upgrade" class="hidden">
            <h2>æœºä½“æ”¹é€ </h2>
            <div class="grid-panel" id="upgrade-list">
                </div>
            <div class="menu-item active" style="margin-top:auto">è¿”å›ä¸»é¡µ</div>
        </div>

        <div id="screen-hud" class="hidden" style="pointer-events: none;">
            <div id="hud-layer">
                <div>HP: <span id="hud-hp" style="color:#0f0">100%</span></div>
                <div>SCORE: <span id="hud-score">0</span></div>
                <div>ğŸ’°: <span class="gold-display">0</span></div>
            </div>
            <div id="pause-overlay" class="hidden">âš ï¸ ä¿¡å·ä¸¢å¤± - è¯·å±•ç¤ºæ‰‹æŒ</div>
        </div>

        <div id="screen-gameover" class="hidden">
            <h1 style="color:red; font-size:50px;">MISSION FAILED</h1>
            <div style="font-size:20px; color:#fff; margin:20px;">
                å­˜æ´»æ—¶é—´: <span id="res-time">0</span>s<br>
                è·å¾—é‡‘å¸: <span id="res-gold">0</span>
            </div>
            <div class="menu-item active">è¿”å›åŸºåœ°</div>
        </div>
    </div>

    <div class="cam-box"><canvas id="output-canvas"></canvas></div>
    <video id="input-video" playsinline></video>
</div>

<script src="js/three.min.js"></script>
<script src="js/camera_utils.js"></script>
<script src="js/control_utils.js"></script>
<script src="js/drawing_utils.js"></script>
<script src="js/hands.js"></script>

<script>
    // ================= 0. å…¨å±€æ•°æ®ä¸å­˜æ¡£ =================
    const GAME_DATA = {
        gold: 0,
        unlocked: ['skin_default', 'w_normal'], // å·²è§£é”ID
        equipped: {
            skin: 'skin_default',
            weapon: 'w_normal',
            armors: []
        },
        upgrades: {
            fireRate: 1, // å°„é€Ÿç­‰çº§
            bulletCount: 1 // å­å¼¹æ•°é‡ç­‰çº§
        }
    };

    // è¯»å–å­˜æ¡£
    const saveStr = localStorage.getItem('skyforce_save');
    if(saveStr) Object.assign(GAME_DATA, JSON.parse(saveStr));

    function saveGame() {
        localStorage.setItem('skyforce_save', JSON.stringify(GAME_DATA));
        document.querySelectorAll('.gold-display').forEach(e => e.innerText = GAME_DATA.gold);
    }
    saveGame(); // åˆå§‹åŒ–æ˜¾ç¤º

    // é…ç½®è¡¨
    const CONFIG = {
        shop: [
            { id: 'w_laser', name: 'è´¯ç©¿æ¿€å…‰', price: 500, type: 'weapon' },
            { id: 'w_scatter', name: 'æ•£å°„ç‚®', price: 800, type: 'weapon' },
            { id: 'a_magnet', name: 'ç£åŠ›è£…ç”² (å¸é‡‘å¸)', price: 300, type: 'armor' },
            { id: 'a_shield', name: 'å¼ºåŠ›æŠ¤ç›¾ (+2HP)', price: 400, type: 'armor' }
        ],
        upgrades: [
            { id: 'u_speed', name: 'å°„é€Ÿå¼ºåŒ–', basePrice: 100, level: () => GAME_DATA.upgrades.fireRate },
            { id: 'u_count', name: 'å¼¹èˆ±æ‰©å®¹', basePrice: 200, level: () => GAME_DATA.upgrades.bulletCount }
        ]
    };

    // ================= 1. å¼•æ“åˆå§‹åŒ– (Three.js) =================
    const container = document.getElementById('drone-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    const scene = new THREE.Scene();
    // 2D æ¸¸æˆä½¿ç”¨æ­£äº¤ç›¸æœº (Left, Right, Top, Bottom, Near, Far)
    // åæ ‡ç³»ï¼šä¸­å¿ƒ(0,0)ï¼Œå®½widthï¼Œé«˜height
    const camera = new THREE.OrthographicCamera(-width/2, width/2, height/2, -height/2, 1, 1000);
    camera.position.z = 100;

    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(width, height);
    document.getElementById('game-canvas').appendChild(renderer.domElement);

    // æ˜Ÿç©ºèƒŒæ™¯ (Canvasç»˜åˆ¶)
    function createStarBg() {
        const cvs = document.createElement('canvas');
        cvs.width = 512; cvs.height = 512;
        const ctx = cvs.getContext('2d');
        ctx.fillStyle = '#000022'; ctx.fillRect(0,0,512,512);
        ctx.fillStyle = '#fff';
        for(let i=0; i<100; i++) {
            ctx.globalAlpha = Math.random();
            ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2);
        }
        const tex = new THREE.CanvasTexture(cvs);
        tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
        return tex;
    }
    const bgTex = createStarBg();
    const bgMat = new THREE.MeshBasicMaterial({ map: bgTex });
    const bgMesh = new THREE.Mesh(new THREE.PlaneGeometry(width, height*2), bgMat);
    bgMesh.position.z = -10;
    scene.add(bgMesh);

    // ================= 2. æ¸¸æˆå®ä½“ç±» =================
    
    // çº¹ç†ç”Ÿæˆå·¥å‚
    const TextureFactory = {
        player: (color) => {
            const cvs = document.createElement('canvas'); cvs.width=64; cvs.height=64;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = color;
            ctx.beginPath(); ctx.moveTo(32,0); ctx.lineTo(64,64); ctx.lineTo(32,48); ctx.lineTo(0,64); ctx.fill();
            // é©¾é©¶èˆ±
            ctx.fillStyle = '#00ffff'; ctx.beginPath(); ctx.arc(32, 35, 5, 0, Math.PI*2); ctx.fill();
            return new THREE.CanvasTexture(cvs);
        },
        enemy: (type) => {
            const cvs = document.createElement('canvas'); cvs.width=64; cvs.height=64;
            const ctx = cvs.getContext('2d');
            if(type==='basic') {
                ctx.fillStyle = '#ff4444'; // çº¢è‰²æ•Œæœº
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(64,0); ctx.lineTo(32,64); ctx.fill();
            } else if(type==='boss') {
                ctx.fillStyle = '#cc00ff'; // ç´«è‰²BOSS
                ctx.fillRect(10,10,44,44); ctx.strokeStyle='#fff'; ctx.lineWidth=4; ctx.strokeRect(10,10,44,44);
            }
            return new THREE.CanvasTexture(cvs);
        },
        bullet: (isPlayer) => {
            const cvs = document.createElement('canvas'); cvs.width=16; cvs.height=32;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = isPlayer ? '#ffff00' : '#ff0000';
            ctx.fillRect(4,0,8,32);
            return new THREE.CanvasTexture(cvs);
        },
        gold: () => {
            const cvs = document.createElement('canvas'); cvs.width=32; cvs.height=32;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(16,16,14,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.font='20px Arial'; ctx.fillText('$', 10, 22);
            return new THREE.CanvasTexture(cvs);
        }
    };

    class Entity {
        constructor(tex, x, y, w, h) {
            this.mesh = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
            this.mesh.scale.set(w, h, 1);
            this.mesh.position.set(x, y, 0);
            this.width = w; this.height = h;
            this.active = true;
            scene.add(this.mesh);
        }
        remove() {
            this.active = false;
            scene.remove(this.mesh);
        }
        update() {}
        checkCollide(other) {
            const dx = Math.abs(this.mesh.position.x - other.mesh.position.x);
            const dy = Math.abs(this.mesh.position.y - other.mesh.position.y);
            return (dx < (this.width + other.width)/3) && (dy < (this.height + other.height)/3);
        }
    }

    // ================= 3. æ¸¸æˆé€»è¾‘çŠ¶æ€æœº =================
    const STATE = { MENU: 0, PLAY: 1, PAUSE: 2, GAMEOVER: 3, SHOP: 4, UPGRADE: 5 };
    let currentState = STATE.MENU;
    
    // æ¸¸æˆè¿è¡Œæ—¶å˜é‡
    let entities = { bullets: [], enemies: [], loots: [] };
    let player = null;
    let gameTime = 0;
    let score = 0;
    let goldInGame = 0;
    let frames = 0;

    // ç©å®¶ç±»
    class Player extends Entity {
        constructor() {
            super(TextureFactory.player('#00ccff'), 0, -200, 50, 50);
            this.hp = 3 + (GAME_DATA.equipped.armors.includes('a_shield') ? 2 : 0);
            this.maxHp = this.hp;
            this.lastShot = 0;
            this.magnet = GAME_DATA.equipped.armors.includes('a_magnet');
        }
        update(inputPos) {
            // è·Ÿéšæ‰‹åŠ¿ (1:1 æ˜ å°„)
            // inputPos æ˜¯ -1 ~ 1
            const targetX = inputPos.x * (width/2 - 30);
            const targetY = inputPos.y * (height/2 - 30);
            
            // å¹³æ»‘ç§»åŠ¨
            this.mesh.position.x += (targetX - this.mesh.position.x) * 0.2;
            this.mesh.position.y += (targetY - this.mesh.position.y) * 0.2;

            // è‡ªåŠ¨å°„å‡»
            if(frames - this.lastShot > (20 - GAME_DATA.upgrades.fireRate * 2)) {
                this.shoot();
                this.lastShot = frames;
            }
        }
        shoot() {
            const count = GAME_DATA.upgrades.bulletCount;
            const weapon = GAME_DATA.equipped.weapon;
            
            for(let i=0; i<count; i++) {
                const offset = (i - (count-1)/2) * 15;
                const b = new Entity(TextureFactory.bullet(true), this.mesh.position.x + offset, this.mesh.position.y + 20, 10, 20);
                b.speedY = 10;
                if(weapon === 'w_scatter') b.speedX = offset * 0.1; // æ•£å°„
                else b.speedX = 0;
                
                b.update = function() {
                    this.mesh.position.y += this.speedY;
                    this.mesh.position.x += this.speedX;
                    if(this.mesh.position.y > height/2) this.remove();
                };
                entities.bullets.push(b);
            }
        }
        hit() {
            this.hp--;
            document.getElementById('hud-hp').innerText = Math.floor(this.hp/this.maxHp*100) + "%";
            if(this.hp <= 0) gameOver();
        }
    }

    function startGame() {
        // æ¸…ç†åœºæ™¯
        [...entities.bullets, ...entities.enemies, ...entities.loots].forEach(e => e.remove());
        entities = { bullets: [], enemies: [], loots: [] };
        if(player) player.remove();

        player = new Player();
        score = 0;
        goldInGame = 0;
        gameTime = 0;
        switchScreen('screen-hud');
        document.getElementById('screen-hud').classList.remove('hidden'); // æ˜¾ç¤ºHUD
        
        currentState = STATE.PLAY;
    }

    function gameOver() {
        currentState = STATE.GAMEOVER;
        GAME_DATA.gold += goldInGame;
        saveGame();
        
        document.getElementById('res-time').innerText = Math.floor(gameTime);
        document.getElementById('res-gold').innerText = goldInGame;
        switchScreen('screen-gameover');
    }

    // ================= 4. UI ä¸ èœå•æ§åˆ¶ =================
    const screens = ['screen-start', 'screen-shop', 'screen-upgrade', 'screen-gameover', 'screen-hud'];
    let menuIndex = 0;
    let menuItems = [];
    let lastMenuMove = 0;

    function switchScreen(id) {
        screens.forEach(s => document.getElementById(s).classList.add('hidden'));
        const active = document.getElementById(id);
        active.classList.remove('hidden');
        
        // é‡æ–°è·å–å½“å‰é¡µé¢çš„èœå•é¡¹
        if(id !== 'screen-hud') {
            menuItems = Array.from(active.querySelectorAll('.menu-item'));
            menuIndex = 0;
            updateMenuHighlight();
        }
    }

    function updateMenuHighlight() {
        menuItems.forEach((item, idx) => {
            if(idx === menuIndex) item.classList.add('active');
            else item.classList.remove('active');
        });
    }

    // èœå•æ“ä½œé€»è¾‘
    function handleMenuInput(handY, isFist) {
        const now = Date.now();
        if (now - lastMenuMove > 400) { // å†·å´å»¶è¿Ÿ 400ms
            if (handY < -0.3) { // ä¸Š
                menuIndex = (menuIndex - 1 + menuItems.length) % menuItems.length;
                lastMenuMove = now;
                updateMenuHighlight();
            } else if (handY > 0.3) { // ä¸‹
                menuIndex = (menuIndex + 1) % menuItems.length;
                lastMenuMove = now;
                updateMenuHighlight();
            }
        }

        if (isFist && now - lastMenuMove > 1000) { // ç¡®è®¤ (é•¿å†·å´é˜²æ­¢è¿ç‚¹)
            lastMenuMove = now;
            const action = menuItems[menuIndex];
            
            // è·¯ç”±é€»è¾‘
            if (currentState === STATE.MENU) {
                if (action.id === 'btn-start') startGame();
                else if (action.id === 'btn-shop') { initShop(); currentState = STATE.SHOP; switchScreen('screen-shop'); }
                else if (action.id === 'btn-upgrade') { initUpgrade(); currentState = STATE.UPGRADE; switchScreen('screen-upgrade'); }
            } else if (currentState === STATE.SHOP || currentState === STATE.UPGRADE) {
                if (action.innerText.includes("è¿”å›")) {
                    currentState = STATE.MENU;
                    switchScreen('screen-start');
                } else {
                    // è´­ä¹°/å‡çº§é€»è¾‘
                    const itemId = action.dataset.id;
                    buyOrEquip(itemId);
                }
            } else if (currentState === STATE.GAMEOVER) {
                currentState = STATE.MENU;
                switchScreen('screen-start');
            }
        }
    }

    // æ„å»ºå•†åº— UI
    function initShop() {
        const list = document.getElementById('shop-list');
        list.innerHTML = '';
        CONFIG.shop.forEach(item => {
            const div = document.createElement('div');
            div.className = 'menu-item shop-card';
            if (GAME_DATA.unlocked.includes(item.id)) {
                div.className += ' owned';
                div.innerHTML = `${item.name}<br>âœ… å·²æ‹¥æœ‰`;
            } else {
                div.innerHTML = `${item.name}<br>ğŸ’° ${item.price}`;
            }
            div.dataset.id = item.id;
            div.dataset.price = item.price;
            list.appendChild(div);
        });
        menuItems = Array.from(list.querySelectorAll('.menu-item'));
        // æ·»åŠ è¿”å›æŒ‰é’®
        menuItems.push(document.querySelector('#screen-shop .menu-item:last-child'));
    }

    // è´­ä¹°é€»è¾‘
    function buyOrEquip(id) {
        // å¦‚æœæ˜¯è¿”å›æŒ‰é’®ï¼ŒIDæ˜¯ undefinedï¼Œå·²ç»åœ¨ handleMenuInput å¤„ç†äº†
        if(!id) return; 

        // æ£€æŸ¥æ˜¯å¦æ˜¯å•†åº—ç‰©å“
        const shopItem = CONFIG.shop.find(i => i.id === id);
        if (shopItem) {
            if (!GAME_DATA.unlocked.includes(id)) {
                if (GAME_DATA.gold >= shopItem.price) {
                    GAME_DATA.gold -= shopItem.price;
                    GAME_DATA.unlocked.push(id);
                    saveGame();
                    initShop(); // åˆ·æ–°æ˜¾ç¤º
                }
            }
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å‡çº§
        // (ç•¥ï¼Œé€»è¾‘ç±»ä¼¼ï¼Œå¢åŠ  upgrades å¯¹åº”å€¼)
    }

    // ================= 5. æ‰‹åŠ¿è¯†åˆ«å¾ªç¯ =================
    const videoElement = document.getElementById('input-video');
    const canvasElement = document.getElementById('output-canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    // è¾“å…¥çŠ¶æ€
    let handPos = { x: 0, y: 0 };
    let isHandDetected = false;
    let isFist = false;

    function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            isHandDetected = true;
            const landmarks = results.multiHandLandmarks[0];
            
            // ç”»éª¨æ¶
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

            // è®¡ç®—ä¸­å¿ƒ
            const cx = landmarks[9].x; 
            const cy = landmarks[9].y;
            
            // åæ ‡æ˜ å°„ï¼šMediaPipe (0~1) -> æ¸¸æˆé€»è¾‘ (-1~1)
            // æ³¨æ„ X è½´ç¿»è½¬
            handPos.x = (0.5 - cx) * 2; 
            handPos.y = (0.5 - cy) * 2; // ä¸Šæ˜¯æ­£ï¼Œä¸‹æ˜¯è´Ÿ

            // æ¡æ‹³æ£€æµ‹
            const tips = [8, 12, 16, 20];
            let extended = 0;
            tips.forEach(i => {
                if (landmarks[i].y < landmarks[i-2].y) extended++; // ç®€å•åˆ¤æ–­æ‰‹æŒ‡ä¼¸ç›´
            });
            isFist = (extended < 2); // æ¡æ‹³

            // --- çŠ¶æ€åˆ†å‘ ---
            if (currentState === STATE.PLAY) {
                document.getElementById('pause-overlay').classList.add('hidden');
                player.update(handPos);
            } else {
                // èœå•æ§åˆ¶
                handleMenuInput(handPos.y, isFist);
            }

        } else {
            isHandDetected = false;
            if (currentState === STATE.PLAY) {
                document.getElementById('pause-overlay').classList.remove('hidden');
            }
        }
        canvasCtx.restore();
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
    hands.onResults(onResults);

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 320, height: 240
    });
    cameraUtils.start();

    // ================= 6. æ¸¸æˆä¸»å¾ªç¯ =================
    function animate() {
        requestAnimationFrame(animate);
        
        // èƒŒæ™¯æ»šåŠ¨
        bgTex.offset.y -= 0.002;

        if (currentState === STATE.PLAY && isHandDetected) {
            frames++;
            gameTime += 1/60;

            // ç”Ÿæˆæ•Œäºº (ç®€å•é€»è¾‘)
            if (frames % 60 === 0) {
                const e = new Entity(TextureFactory.enemy('basic'), (Math.random()-0.5)*width, height/2 + 50, 40, 40);
                e.hp = 1;
                e.update = function() {
                    this.mesh.position.y -= 2;
                    // è¿½è¸ªç©å®¶
                    if(this.mesh.position.x < player.mesh.position.x) this.mesh.position.x += 0.5;
                    else this.mesh.position.x -= 0.5;
                    
                    if(this.mesh.position.y < -height/2) this.remove();
                    
                    // æ’ç©å®¶
                    if(this.active && this.checkCollide(player)) {
                        this.remove(); player.hit();
                    }
                };
                entities.enemies.push(e);
            }

            // æ›´æ–°å®ä½“
            entities.bullets.forEach(b => b.update());
            entities.enemies.forEach(e => {
                e.update();
                // ç¢°æ’æ£€æµ‹ï¼šå­å¼¹æ‰“æ•Œäºº
                entities.bullets.forEach(b => {
                    if(b.active && e.active && b.checkCollide(e)) {
                        b.remove(); e.hp--;
                        if(e.hp <= 0) {
                            e.remove();
                            // çˆ†é‡‘å¸
                            const g = new Entity(TextureFactory.gold(), e.mesh.position.x, e.mesh.position.y, 30, 30);
                            g.update = function() {
                                this.mesh.position.y -= 1;
                                // ç£åŠ›
                                if(player.magnet) {
                                    this.mesh.position.x += (player.mesh.position.x - this.mesh.position.x)*0.1;
                                    this.mesh.position.y += (player.mesh.position.y - this.mesh.position.y)*0.1;
                                }
                                if(this.checkCollide(player)) {
                                    this.remove(); goldInGame += 10;
                                    document.querySelector('#screen-hud .gold-display').innerText = goldInGame;
                                }
                            };
                            entities.loots.push(g);
                        }
                    }
                });
            });
            entities.loots.forEach(l => l.update());

            // æ¸…ç†å¤±æ•ˆå®ä½“
            entities.bullets = entities.bullets.filter(e => e.active);
            entities.enemies = entities.enemies.filter(e => e.active);
            entities.loots = entities.loots.filter(e => e.active);
        }

        renderer.render(scene, camera);
    }
    animate();

</script>